var $e=Object.defineProperty;var Le=(o,r,s)=>r in o?$e(o,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[r]=s;var re=(o,r,s)=>Le(o,typeof r!="symbol"?r+"":r,s);import{t,v as e,w as Oe,x as Pe,y as De}from"./vendor-HPR0y5QN.js";import{u as ne,m as le,a as oe,_ as he,y as me,P as fe,b as ze,L as Fe,p as Re,n as Ke}from"./esri-CV-Xl794.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&l(m)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();const Y=()=>"https://redfive-api-1092564995915.us-central1.run.app",xe=t.createContext(void 0),pe=()=>{const o=t.useContext(xe);if(o===void 0)throw new Error("useAuth must be used within an AuthProvider");return o},qe=({children:o})=>{const[r,s]=t.useState(null),[l,n]=t.useState(!0),[a,m]=t.useState(!1);t.useEffect(()=>{if(window.google&&window.google.accounts){n(!1);return}if(document.querySelector('script[src="https://accounts.google.com/gsi/client"]')){const N=()=>{window.google&&window.google.accounts?n(!1):setTimeout(N,100)};N();return}const b=()=>{window.google&&window.google.accounts?n(!1):setTimeout(b,100)},v=document.createElement("script");v.src="https://accounts.google.com/gsi/client",v.async=!0,v.defer=!0,v.onload=b,v.onerror=()=>{n(!1)},document.head.appendChild(v);const A=localStorage.getItem("user"),_=localStorage.getItem("access_token");if(A&&_)try{(w=>{try{const C=JSON.parse(atob(w.split(".")[1])),T=Date.now()/1e3;return C.exp<T}catch{return!0}})(_)?setTimeout(async()=>{const w=localStorage.getItem("refresh_token");if(w){const C=Y();try{const T=await fetch(`${C}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refresh_token:w})});if(T.ok){const M=await T.json();M.access_token&&(localStorage.setItem("access_token",M.access_token),M.refresh_token&&localStorage.setItem("refresh_token",M.refresh_token),s(JSON.parse(A)))}else localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}catch{localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}}else localStorage.removeItem("user"),localStorage.removeItem("access_token")},100):s(JSON.parse(A))}catch{localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}return()=>{const N=document.querySelector('script[src="https://accounts.google.com/gsi/client"]');N&&N.remove()}},[]);const x={user:r,isAuthenticated:!!r,isLoading:l,login:()=>{if(a||!window.google||!window.google.accounts)return;const S="1092564995915-914iml3sjt13lcb6c038cniqe72374h9.apps.googleusercontent.com";m(!0),window.google.accounts.oauth2.initTokenClient({client_id:S,scope:"openid profile email",ux_mode:"redirect",redirect_uri:window.location.origin,callback:v=>{v.access_token?fetch(`https://www.googleapis.com/oauth2/v2/userinfo?access_token=${v.access_token}`).then(A=>A.json()).then(A=>{const _=Y();return fetch(`${_}/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({access_token:v.access_token,user_info:A})}).then(N=>N.json()).then(N=>{if(N.success||N.user){const w={id:N.user?.id||A.id,name:N.user?.name||A.name,email:N.user?.email||A.email,picture:N.user?.picture||A.picture};s(w),localStorage.setItem("user",JSON.stringify(w))}m(!1)})}).catch(()=>{m(!1)}):m(!1)}}).requestAccessToken()},logout:()=>{const S=Y();fetch(`${S}/auth/logout`,{method:"POST",credentials:"include"}).catch(()=>{}),s(null),m(!1),localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),window.google&&window.google.accounts&&window.google.accounts.oauth2.revoke()},refreshToken:async()=>{try{const S=localStorage.getItem("refresh_token");if(!S)return!1;const b=Y(),v=await fetch(`${b}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refresh_token:S})});if(!v.ok)return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),s(null),!1;const A=await v.json();return A.access_token?(localStorage.setItem("access_token",A.access_token),A.refresh_token&&localStorage.setItem("refresh_token",A.refresh_token),!0):!1}catch{return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),s(null),!1}}};return e.jsx(xe.Provider,{value:x,children:o})},Ue=({children:o})=>{const{isAuthenticated:r,isLoading:s}=pe(),l=t.useRef(null),n=t.useRef(!1),[a,m]=t.useState(!1);return t.useEffect(()=>{if(!n.current&&!s&&!r&&window.google&&window.google.accounts&&l.current){const y="1092564995915-914iml3sjt13lcb6c038cniqe72374h9.apps.googleusercontent.com";n.current=!0,l.current&&(l.current.innerHTML=""),window.google.accounts.id.initialize({client_id:y,callback:i=>{if(i.credential){m(!0);const p=JSON.parse(atob(i.credential.split(".")[1])),x=Y();fetch(`${x}/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({token:i.credential})}).then(S=>S.ok?S.json():S.json().then(b=>{throw new Error(`Server error: ${JSON.stringify(b)}`)})).then(S=>{if(S.access_token){localStorage.setItem("access_token",S.access_token),localStorage.setItem("refresh_token",S.refresh_token);const b={id:p.sub,name:p.name,email:p.email,picture:p.picture};localStorage.setItem("user",JSON.stringify(b)),setTimeout(()=>{window.location.reload()},1e3)}}).catch(()=>{m(!1)})}}}),window.google.accounts.id.renderButton(l.current,{theme:"outline",size:"large",text:"signin_with",shape:"rectangular"})}},[s,r]),t.useEffect(()=>()=>{n.current=!1},[]),s?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"spinner-border text-primary mb-3",role:"status",style:{width:"3rem",height:"3rem"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("h4",{children:"Initializing..."}),e.jsx("p",{className:"text-muted",children:"Setting up authentication"})]})}):a?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"spinner-border text-primary mb-3",role:"status",style:{width:"3rem",height:"3rem"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("h4",{children:"Authenticating..."}),e.jsx("p",{className:"text-muted",children:"Please wait while we verify your identity"})]})}):r?e.jsx(e.Fragment,{children:o}):e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"card shadow-lg border-0",style:{maxWidth:"400px",margin:"0 auto"},children:e.jsxs("div",{className:"card-body p-5",children:[e.jsx("h4",{className:"card-title text-center mb-4",children:"Welcome"}),e.jsx("p",{className:"text-muted text-center mb-4",children:"Sign in with your Google account to continue"}),e.jsx("div",{ref:l,className:"d-flex justify-content-center"})]})}),e.jsx("div",{className:"mt-4",children:e.jsx("small",{className:"text-muted",children:"Secure authentication powered by Google"})})]})})},He=()=>{const{user:o,isAuthenticated:r,isLoading:s,login:l,logout:n}=pe(),a=()=>{l()},m=()=>{n()};return e.jsx("nav",{className:"navbar navbar-expand-lg navbar-dark",style:{flexShrink:0,padding:"0px",backgroundColor:"#495057"},children:e.jsxs("div",{className:"container-fluid",children:[e.jsxs("a",{className:"navbar-brand fw-bold",href:"#",style:{color:"#aa0000",fontSize:"21pt",lineHeight:"1",padding:"0",margin:"0",textShadow:"1px 1px 2px rgba(255, 255, 255, 0.3)"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("div",{className:"navbar-nav ms-auto",children:s?e.jsxs("div",{className:"nav-link",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Loading..."]}):r&&o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"nav-link d-flex align-items-center",children:[o.picture&&e.jsx("img",{src:o.picture,alt:o.name,className:"rounded-circle me-2",style:{width:"24px",height:"24px"}}),e.jsx("span",{className:"me-3",children:o.name})]}),e.jsxs("a",{className:"nav-link",href:"#",children:[e.jsx("i",{className:"bi bi-gear me-1"}),"Settings"]}),e.jsxs("button",{className:"nav-link btn btn-link text-light text-decoration-none",onClick:m,style:{border:"none",background:"none"},children:[e.jsx("i",{className:"bi bi-box-arrow-right me-1"}),"Logout"]})]}):e.jsxs("button",{className:"nav-link btn btn-link text-light text-decoration-none",onClick:a,style:{border:"none",background:"none"},children:[e.jsx("i",{className:"bi bi-google me-1"}),"Login with Google"]})})]})})};class ce{constructor(r,s){re(this,"baseUrl");re(this,"apiKey");this.baseUrl=r||Y(),this.apiKey=s}async sendPrompt(r){try{const s={query:r},l={"Content-Type":"application/json",Accept:"application/json"},n=await this.getValidToken();n?l.Authorization=`Bearer ${n}`:this.apiKey&&(l.Authorization=`Bearer ${this.apiKey}`);const a=await fetch(`${this.baseUrl}/generate-sql`,{method:"POST",headers:l,body:JSON.stringify(s),mode:"cors",credentials:"include",cache:"no-cache"});if(!a.ok){const y=await a.text();throw new Error(`HTTP error! status: ${a.status} - ${y}`)}return{success:!0,data:await a.json(),message:"Request processed successfully"}}catch(s){let l="Unknown error occurred";return s instanceof TypeError&&s.message.includes("Failed to fetch")?l=`Network error: Unable to connect to the data service. Please check if the service is running at ${this.baseUrl}`:s instanceof Error&&(l=s.message),{success:!1,error:l,message:"Failed to process request"}}}async executeSql(r){try{const s={sql:r},l={"Content-Type":"application/json",Accept:"application/json"},n=await this.getValidToken();n?l.Authorization=`Bearer ${n}`:this.apiKey&&(l.Authorization=`Bearer ${this.apiKey}`);const a=await fetch(`${this.baseUrl}/execute-sql`,{method:"POST",headers:l,body:JSON.stringify(s),mode:"cors",credentials:"include",cache:"no-cache"});if(!a.ok){const y=await a.text();throw new Error(`HTTP error! status: ${a.status} - ${y}`)}return{success:!0,data:await a.json(),message:"SQL executed successfully"}}catch(s){let l="Unknown error occurred";return s instanceof TypeError&&s.message.includes("Failed to fetch")?l="Network error: Unable to connect to the data service":s instanceof Error&&(l=s.message),{success:!1,error:l,message:"Failed to execute SQL"}}}async getHealth(){try{const r=await fetch(`${this.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return{success:!0,data:await r.json(),message:"Service is healthy"}}catch(r){return{success:!1,error:r instanceof Error?r.message:"Health check failed",message:"Service is unavailable"}}}setBaseUrl(r){this.baseUrl=r}setApiKey(r){this.apiKey=r}async getModels(){try{const r={"Content-Type":"application/json",Accept:"application/json"},s=await this.getValidToken();s?r.Authorization=`Bearer ${s}`:this.apiKey&&(r.Authorization=`Bearer ${this.apiKey}`);const l=await fetch(`${this.baseUrl}/get-models`,{method:"GET",headers:r,mode:"cors",credentials:"include",cache:"no-cache"});if(!l.ok){const a=await l.text();throw new Error(`HTTP error! status: ${l.status} - ${a}`)}return{success:!0,data:await l.json(),message:"Models retrieved successfully"}}catch(r){let s="Unknown error occurred";return r instanceof TypeError&&r.message.includes("Failed to fetch")?s="Network error: Unable to connect to the data service":r instanceof Error&&(s=r.message),{success:!1,error:s,message:"Failed to get models"}}}async refreshToken(){try{const r=localStorage.getItem("refresh_token");if(!r)return{success:!1,error:"No refresh token available",message:"Please log in again"};const s={"Content-Type":"application/json",Accept:"application/json"},l=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:s,body:JSON.stringify({refresh_token:r}),mode:"cors",credentials:"include",cache:"no-cache"});if(!l.ok){const a=await l.text();return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),{success:!1,error:`Token refresh failed: ${a}`,message:"Please log in again"}}const n=await l.json();return n.access_token&&(localStorage.setItem("access_token",n.access_token),n.refresh_token&&localStorage.setItem("refresh_token",n.refresh_token)),{success:!0,data:n,message:"Token refreshed successfully"}}catch(r){return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred",message:"Token refresh failed, please log in again"}}}isTokenExpired(r){try{const s=JSON.parse(atob(r.split(".")[1])),l=Date.now()/1e3;return s.exp<l}catch{return!0}}async getValidToken(){const r=localStorage.getItem("access_token");if(!r)return null;if(this.isTokenExpired(r)){const s=await this.refreshToken();return s.success&&s.data?.access_token?s.data.access_token:null}return r}async saveQuery(r){try{const s={"Content-Type":"application/json",Accept:"application/json"},l=await this.getValidToken();l?s.Authorization=`Bearer ${l}`:this.apiKey&&(s.Authorization=`Bearer ${this.apiKey}`);const n=await fetch(`${this.baseUrl}/save-query`,{method:"POST",headers:s,body:JSON.stringify(r),mode:"cors",credentials:"include",cache:"no-cache"});if(!n.ok){const m=await n.text();throw new Error(`HTTP error! status: ${n.status} - ${m}`)}return{success:!0,data:await n.json(),message:"Query saved successfully"}}catch(s){let l="Unknown error occurred";return s instanceof TypeError&&s.message.includes("Failed to fetch")?l="Network error: Unable to connect to the data service":s instanceof Error&&(l=s.message),{success:!1,error:l,message:"Failed to save query"}}}async listQueries(){try{const r={"Content-Type":"application/json",Accept:"application/json"},s=await this.getValidToken();s?r.Authorization=`Bearer ${s}`:this.apiKey&&(r.Authorization=`Bearer ${this.apiKey}`);const l=await fetch(`${this.baseUrl}/list-queries`,{method:"GET",headers:r,mode:"cors",credentials:"include",cache:"no-cache"});if(!l.ok){const a=await l.text();throw new Error(`HTTP error! status: ${l.status} - ${a}`)}return{success:!0,data:await l.json(),message:"Queries retrieved successfully"}}catch(r){let s="Unknown error occurred";return r instanceof TypeError&&r.message.includes("Failed to fetch")?s="Network error: Unable to connect to the data service":r instanceof Error&&(s=r.message),{success:!1,error:s,message:"Failed to list queries"}}}}const Be=({className:o="",onTableSelect:r,onColumnSelect:s,onSchemaSelect:l,onModelsLoaded:n,onGenerateSelect:a,onSpatialColumnsLoaded:m,onTableDocumentationSelect:y,onQuerySelect:i,onRefreshQueries:p})=>{const[x,S]=t.useState({databases:!0,production:!0,schemas:!0,"saved-queries":!1}),[b,v]=t.useState([]),[A,_]=t.useState(!1),[N,w]=t.useState([]),[C,T]=t.useState(!1),[M,F]=t.useState({show:!1,x:0,y:0,type:"table",item:null}),c=new ce,d=h=>{S(E=>({...E,[h]:!E[h]}))},f=h=>{const E={};let j=[];if(Array.isArray(h))j=h;else if(h&&Array.isArray(h.data))j=h.data;else if(h&&h.models&&Array.isArray(h.models))j=h.models;else return E;return j.forEach(z=>{const L=z.schema||z.schema_name||z.database_schema||"default",R=z.name||z.table_name;E[L]||(E[L]={}),E[L][R]||(E[L][R]=[]),z.columns&&(E[L][R]=z.columns)}),Object.keys(E).forEach(z=>{Object.keys(E[z]).forEach(L=>{E[z][L].sort((R,D)=>R.name.localeCompare(D.name))})}),E},I=h=>{const E=[];return h.forEach(j=>{j.columns&&Array.isArray(j.columns)&&j.columns.forEach(z=>{z.spatial_type&&z.spatial_type!==null&&z.spatial_type!==""&&E.push(z.name)})}),E},O=t.useMemo(()=>b.length===0?{}:f(b),[b]),P=async()=>{_(!0);try{const h=await c.getModels();if(h.success&&h.data){let E=[];if(Array.isArray(h.data))E=h.data;else if(h.data.models&&Array.isArray(h.data.models))E=h.data.models;else{v([]);return}v(E);const j=I(E);n&&n(E),m&&m(j);const z=f(E),L={databases:!0,production:!0,schemas:!0,"saved-queries":!1};Object.keys(z).forEach(R=>{L[`schema-${R}`]=!0}),S(L)}else v([])}catch{v([])}finally{_(!1)}},K=async()=>{T(!0);try{const h=await c.listQueries();if(h.success&&h.data){let E=[];if(Array.isArray(h.data))E=h.data;else if(h.data.queries&&Array.isArray(h.data.queries))E=h.data.queries;else{w([]);return}w(E)}else w([])}catch{w([])}finally{T(!1)}};t.useEffect(()=>{P(),K()},[]),t.useEffect(()=>{b.length>0&&n&&n(b)},[b,n]),t.useEffect(()=>{p&&p(K)},[p]);const q=(h,E,j)=>{h.preventDefault(),h.stopPropagation(),F({show:!0,x:h.clientX,y:h.clientY,type:E,item:j})},$=()=>{F({show:!1,x:0,y:0,type:"table",item:null})};return t.useEffect(()=>{const h=()=>{M.show&&$()};return document.addEventListener("click",h),()=>document.removeEventListener("click",h)},[M.show]),e.jsxs("div",{className:`bg-light border-end d-flex flex-column h-100 ${o}`,style:{overflow:"hidden"},children:[e.jsx("div",{className:"p-2 border-bottom panel-header",style:{background:"linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"text-muted mb-0 d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-folder me-2"}),"Model Explorer"]}),e.jsx("div",{className:"d-flex gap-1",children:e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>{P(),K()},disabled:A||C,title:"Reload models and queries",children:A||C?e.jsx("i",{className:"bi bi-hourglass-split"}):e.jsx("i",{className:"bi bi-arrow-clockwise"})})})]})}),e.jsx("div",{className:"flex-grow-1",style:{height:"0",minHeight:"0",overflowY:"auto",overflowX:"hidden"},onContextMenu:h=>{h.preventDefault(),h.stopPropagation()},children:A?e.jsxs("div",{className:"p-3 text-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-muted",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"small text-muted mt-2",children:"Loading models..."})]}):b.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{console.log("ðŸ”¥ SCHEMAS NODE CLICKED!"),d("schemas"),l?(console.log("ðŸ”¥ Calling onSchemaSelect with default"),l("default")):console.log("ðŸ”¥ onSchemaSelect is not defined!")},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${x.schemas?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:"Schemas"})]}),x.schemas&&e.jsx("div",{className:"explorer-children",children:Object.entries(O).sort(([h],[E])=>h.localeCompare(E)).map(([h,E])=>e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{d(`schema-${h}`),l&&l(h)},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${x[`schema-${h}`]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:h})]}),x[`schema-${h}`]&&e.jsx("div",{className:"explorer-children",children:Object.entries(E).sort(([j],[z])=>j.localeCompare(z)).map(([j,z])=>{const L=Array.isArray(b)?b.find(R=>R.name===j):null;return e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{d(`table-${h}-${j}`),r&&L&&r(L),y&&L&&y(L)},onContextMenu:R=>{R.preventDefault(),R.stopPropagation(),q(R,"table",L||{name:j,schema:h})},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${x[`table-${h}-${j}`]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-table me-2"}),e.jsx("span",{children:j})]}),x[`table-${h}-${j}`]&&e.jsx("div",{className:"explorer-children",children:z.map(R=>e.jsxs("div",{className:"explorer-file",onClick:()=>{s&&s(R.name)},onContextMenu:D=>{D.preventDefault(),D.stopPropagation(),q(D,"column",R)},style:{cursor:"pointer"},children:[e.jsx("i",{className:"bi bi-columns me-2"}),e.jsxs("span",{children:[R.name,R.spatial_type==="point"?e.jsx("span",{style:{color:"#aa0000"},children:"*"}):R.spatial_type==="polyline"?e.jsx("span",{style:{color:"#aa0000"},children:"**"}):R.spatial_type==="polygon"?e.jsx("span",{style:{color:"#aa0000"},children:"***"}):""]}),e.jsxs("span",{className:"text-muted small ms-2",children:["(",R.type,")"]})]},R.name))})]},j)})})]},h))})]}),e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>d("saved-queries"),children:[e.jsx("i",{className:`bi ${x["saved-queries"]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:"Saved Queries"})]}),x["saved-queries"]&&e.jsx("div",{className:"explorer-children",children:C?e.jsxs("div",{className:"p-2 text-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-muted",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"small text-muted mt-1",children:"Loading queries..."})]}):N.length>0?N.map(h=>e.jsxs("div",{className:"explorer-file",onClick:()=>{i&&i(h)},style:{cursor:"pointer"},children:[e.jsx("i",{className:"bi bi-file-text me-2"}),e.jsx("span",{children:h.name}),h.isPublic&&e.jsx("i",{className:"bi bi-globe ms-2 text-info",title:"Public query"})]},h.guid)):e.jsxs("div",{className:"p-2 text-center text-muted",children:[e.jsx("i",{className:"bi bi-file-text fs-4 mb-1"}),e.jsx("div",{className:"small",children:"No saved queries"})]})})]})]}):e.jsxs("div",{className:"p-3 text-center text-muted",children:[e.jsx("i",{className:"bi bi-database fs-1 mb-2"}),e.jsx("div",{children:"No models loaded"}),e.jsx("small",{children:"Models will appear here once loaded"})]})}),M.show&&e.jsx("div",{className:"context-menu",style:{position:"fixed",top:M.y,left:M.x,zIndex:9999,backgroundColor:"white",border:"1px solid #ccc",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",padding:"4px 0",minWidth:"180px",fontSize:"14px"},onClick:h=>h.stopPropagation(),children:M.type==="table"&&a&&e.jsxs("div",{className:"context-menu-item",onClick:()=>{a(M.item),F({show:!1,x:0,y:0,type:"table",item:null})},style:{padding:"10px 16px",cursor:"pointer",fontSize:"14px",display:"flex",alignItems:"center",gap:"10px",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s"},onMouseEnter:h=>{h.currentTarget.style.backgroundColor="#f8f9fa"},onMouseLeave:h=>{h.currentTarget.style.backgroundColor="transparent"},children:[e.jsx("i",{className:"bi bi-code-slash text-success"}),e.jsx("span",{children:"Generate Select"})]})})]})},Ge=t.memo(Be),Qe=({results:o,columns:r,isExecuting:s,error:l,selectedRowIndex:n,onRowSelect:a})=>{const m=t.useRef(null);return t.useEffect(()=>{const y=p=>{if(o.length!==0){if(p.key==="ArrowDown"){p.preventDefault();const x=n===null?0:Math.min(n+1,o.length-1);a(x)}else if(p.key==="ArrowUp"){p.preventDefault();const x=n===null?0:Math.max(n-1,0);a(x)}}},i=m.current;if(i)return i.addEventListener("keydown",y),()=>i.removeEventListener("keydown",y)},[o.length,n,a]),t.useEffect(()=>{o.length>0&&n===null&&a(0)},[o.length,n,a]),e.jsxs("div",{ref:m,className:"p-2 flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},tabIndex:0,onFocus:()=>{m.current&&m.current.focus()},children:[s&&e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-danger",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-2 text-muted",children:"Executing query..."})]})}),l&&e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),e.jsx("strong",{children:"Query Error:"})," ",l]}),!s&&!l&&o.length>0&&e.jsx("div",{className:"flex-grow-1",style:{overflowY:"auto",overflowX:"auto",height:"100%",scrollbarWidth:"thin"},children:e.jsxs("table",{className:"table table-striped table-hover table-sm",style:{whiteSpace:"nowrap",fontSize:"0.875rem"},children:[e.jsx("thead",{className:"sticky-top",children:e.jsx("tr",{children:r.map((y,i)=>e.jsx("th",{style:{whiteSpace:"nowrap",padding:"0.5rem 0.6rem 0.4rem 0.6rem",lineHeight:"1.2",color:"white",backgroundColor:"#495057",border:"none"},children:y},i))})}),e.jsx("tbody",{children:o.map((y,i)=>e.jsx("tr",{className:n===i?"table-row-selected":"",style:{lineHeight:"1.2",cursor:"pointer",transition:"background-color 0.2s ease",backgroundColor:n===i?"#e3f2fd":"transparent"},onClick:()=>a(i),onMouseEnter:p=>{n!==i&&(p.currentTarget.style.backgroundColor="#f5f5f5")},onMouseLeave:p=>{n!==i&&(p.currentTarget.style.backgroundColor="transparent")},children:r.map((p,x)=>e.jsx("td",{style:{whiteSpace:"nowrap",padding:"0.4rem 0.6rem",lineHeight:"1.2"},children:y[p]!==null&&y[p]!==void 0?String(y[p]):e.jsx("span",{className:"text-muted",children:"NULL"})},x))},i))})]})}),!s&&!l&&o.length===0&&e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-table display-4 mb-3"}),e.jsx("div",{children:"No results to display"}),e.jsx("small",{children:"Execute a query to see results here"})]})})]})},We=t.memo(Qe),Ve={chart_type:{description:"line, bar, area, scatter, pie"}},Je={properties:Ve},Ye=({queryResults:o,columns:r,onConfigChange:s,initialConfig:l,className:n=""})=>{const[a,m]=t.useState(()=>l?{chart_type:l.chart_type||"bar",x_key:l.x_key||"",y_key:l.y_key||"",series_key:l.series_key||"",series:l.series||[]}:{chart_type:"bar",x_key:"",y_key:"",series_key:"",series:[]}),[y,i]=t.useState(()=>l?.selectedSeriesValues||[]),p=t.useRef(null);t.useEffect(()=>{l?(m({chart_type:l.chart_type||"bar",x_key:l.x_key||"",y_key:l.y_key||"",series_key:l.series_key||"",series:l.series||[]}),i(l.selectedSeriesValues||[])):(m({chart_type:"bar",x_key:"",y_key:"",series_key:"",series:[]}),i([]))},[l]);const x=t.useMemo(()=>Je.properties.chart_type.description?.split(", ")||["line","bar","area","scatter","pie"],[]),S=t.useMemo(()=>!a.series_key||!o||o.length===0?[]:[...new Set(o.map(d=>d[a.series_key]).filter(d=>d!=null))].sort(),[a.series_key,o]),b=t.useMemo(()=>!a.series_key||y.length===0?o:o.filter(c=>y.includes(c[a.series_key])),[o,a.series_key,y]);t.useEffect(()=>{if(a.x_key&&a.y_key&&a.series_key&&o&&o.length>0){const d=[...new Set(o.map(f=>f[a.series_key]).filter(f=>f!=null))].map(f=>({type:a.chart_type,xKey:a.x_key,yKey:a.y_key,seriesValue:f}));m(f=>({...f,series:d}))}else m(c=>({...c,series:[]}))},[a.x_key,a.y_key,a.series_key,a.chart_type,o]),t.useEffect(()=>{if(a.x_key&&a.y_key){const c={...a,filteredData:b,selectedSeriesValues:y};JSON.stringify(c)!==JSON.stringify(p.current)&&(p.current=c,s(c))}},[a.x_key,a.y_key,a.series_key,a.chart_type,a.series,s]);const v=c=>{m(d=>({...d,chart_type:c,series:d.series.map(f=>({...f,type:c}))}))},A=c=>{m(d=>({...d,x_key:c}))},_=c=>{m(d=>({...d,y_key:c}))},N=c=>{m(d=>({...d,series_key:c})),i([])},w=c=>{i(d=>{const f=d.includes(c)?d.filter(I=>I!==c):[...d,c];if(a.x_key&&a.y_key){const I=a.series_key&&f.length>0?o.filter(O=>f.includes(O[a.series_key])):o;s({...a,filteredData:I,selectedSeriesValues:f})}return f})},C=()=>{i(S)},T=()=>{i([])},M=t.useMemo(()=>!o||o.length===0?r:r.filter(c=>{const d=o[0]?.[c];return typeof d=="number"||!isNaN(Number(d))}),[r,o]),F=t.useMemo(()=>!o||o.length===0?r:r.filter(c=>{const d=o[0]?.[c];return typeof d=="string"||typeof d=="object"}),[r,o]);return!o||o.length===0?e.jsxs("div",{className:`p-3 text-center text-muted ${n}`,children:[e.jsx("i",{className:"bi bi-bar-chart display-4 mb-3"}),e.jsx("div",{children:"No Data Available"}),e.jsx("small",{children:"Execute a query to configure charts"})]}):e.jsxs("div",{className:`px-3 py-2 ${n}`,style:{fontSize:"0.85rem"},children:[e.jsx("div",{className:"mb-2",children:e.jsx("h6",{className:"text-muted mb-2",style:{fontSize:"0.9rem"}})}),e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Chart Type"}),e.jsx("select",{className:"form-select",value:a.chart_type,onChange:c=>v(c.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:x.map(c=>e.jsx("option",{value:c,children:c.charAt(0).toUpperCase()+c.slice(1)},c))})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"X-Axis (Category)"}),e.jsxs("select",{className:"form-select",value:a.x_key,onChange:c=>A(c.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select X-axis column"}),F.map(c=>e.jsx("option",{value:c,children:c},c))]})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Y-Axis (Values)"}),e.jsxs("select",{className:"form-select",value:a.y_key,onChange:c=>_(c.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select Y-axis column"}),M.map(c=>e.jsx("option",{value:c,children:c},c))]}),M.length===0&&e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"No numeric columns found for Y-axis"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Series Differentiation"}),e.jsxs("select",{className:"form-select",value:a.series_key,onChange:c=>N(c.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select series column"}),F.map(c=>e.jsx("option",{value:c,children:c},c))]}),e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"Column that groups data into different series"})]}),a.series_key&&S.length>0&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"border-top pt-3 mt-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("label",{className:"form-label fw-bold mb-0",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Filter Series"}),e.jsxs("div",{className:"btn-group btn-group-sm",role:"group",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:C,children:"Select All"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:T,children:"Deselect All"})]})]}),e.jsx("div",{className:"d-flex flex-column gap-2",children:S.map((c,d)=>e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:`series-${d}`,checked:y.includes(c),onChange:()=>w(c),style:{accentColor:"#aa0000"}}),e.jsx("label",{className:"form-check-label",htmlFor:`series-${d}`,children:String(c)})]},c))}),e.jsxs("div",{className:"text-muted small mt-2",style:{fontSize:"0.75rem"},children:["Showing ",y.length===0?S.length:y.length," of ",S.length," series"]})]})})]})]})},Xe=({metadata:o,queryResults:r=[],columns:s=[],chartConfig:l,onChartConfigChange:n,tabId:a})=>{const[m,y]=t.useState(!1),[i,p]=t.useState(!1),[x,S]=t.useState(400),b=t.useRef(null),v=t.useRef(null),A=N=>{v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{S(N)},50)};t.useEffect(()=>{const N=()=>{if(b.current){const F=b.current.clientHeight;F>0&&F!==x&&A(F)}},w=setTimeout(()=>{N()},100),C=new ResizeObserver(()=>{N()}),T=()=>{N()};window.addEventListener("resize",T);const M=setTimeout(()=>{b.current&&C.observe(b.current)},200);return()=>{clearTimeout(w),clearTimeout(M),v.current&&clearTimeout(v.current),C.disconnect(),window.removeEventListener("resize",T)}},[x]),t.useEffect(()=>{const w=setTimeout(()=>{if(b.current){const C=b.current.clientHeight;C>0&&A(C)}},200);return()=>{clearTimeout(w)}},[r?.length,l?.chart_type]);const _=t.useMemo(()=>{if(!l||!r||r.length===0)return null;const{chart_type:N,x_key:w,y_key:C,series_key:T,filteredData:M,selectedSeriesValues:F}=l,c=M&&M.length>0?M:r,d=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d3","#c7c7c7","#dbdb8d","#9edae5"];let f=[],I=[];if(T&&C){const P={};(c||[]).forEach(q=>{const $=q[T];$!=null&&(!F||F.length===0||F.includes($))&&(P[$]||(P[$]=[]),P[$].push(q))}),I=Object.keys(P).map((q,$)=>({type:N,xKey:w,yKey:C,yName:q,data:P[q],connectMissingData:!1,style:{fill:d[$%d.length],stroke:d[$%d.length]},marker:{enabled:!1}})),f=c||[]}else f=c||[],I=[{type:N,xKey:w,yKey:C,data:f,connectMissingData:!1,style:{fill:d[0],stroke:d[0]},marker:{enabled:!1}}];return{data:f,series:I,title:{text:C&&w?`${C.toUpperCase()} by ${w.toUpperCase()}`:"Query Results Visualization",fontSize:16,color:"#aa0000"},background:{fill:"transparent"},axes:[{type:"category",position:"bottom",title:{text:w||"X-Axis"}},{type:"number",position:"left",title:{text:C||"Y-Axis"}}],legend:{enabled:I.length>1,item:{marker:{shape:"square",size:12}}},width:"100%",height:x}},[l,r,x]);return e.jsx("div",{className:"flex-grow-1 d-flex position-relative",style:{height:"100%",overflow:"hidden"},children:r&&r.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",style:{overflow:"hidden",minHeight:0},children:[_?e.jsx("div",{ref:b,className:"flex-grow-1",style:{width:"100%",height:"100%",position:"relative"},children:e.jsx("div",{style:{width:"100%",height:"100%"},children:e.jsx(Oe,{options:_})})}):e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-bar-chart display-4 mb-3"}),e.jsx("div",{children:"Configure Chart"}),e.jsx("small",{children:"Use the configuration panel to set up your visualization"})]})}),o&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>p(!i),style:{fontSize:"0.8rem"},children:[e.jsx("i",{className:`bi ${i?"bi-chevron-down":"bi-chevron-right"} me-1`}),"Raw Metadata"]}),i&&e.jsx("div",{className:"mt-2",style:{maxHeight:"200px",overflow:"auto"},children:e.jsx("pre",{className:"bg-light p-3 rounded",style:{fontSize:"0.75rem",lineHeight:"1.4",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(o,null,2)})})]}),!m&&e.jsx("div",{className:"position-absolute",style:{top:"10px",right:"10px",zIndex:1e3},children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"white",borderColor:"#aa0000",color:"#aa0000",fontSize:"0.75rem",padding:"0.25rem 0.5rem"},onClick:()=>y(!0),title:"Open configuration panel",children:"Show Config"})})]}),e.jsxs("div",{className:`border-start bg-light d-flex flex-column ${m?"":"d-none"}`,style:{width:"350px",minWidth:"350px"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-3 py-2 border-bottom",children:[e.jsx("h6",{className:"mb-0 text-muted",style:{fontSize:"0.9rem"},children:"Chart Configuration"}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"white",borderColor:"#aa0000",color:"#aa0000",fontSize:"0.75rem"},onClick:()=>y(!m),title:m?"Collapse configuration":"Expand configuration",children:"Hide Config"})]}),e.jsx("div",{className:"flex-grow-1",style:{overflow:"auto"},children:e.jsx(Ye,{queryResults:r,columns:s,onConfigChange:n,initialConfig:l},a)})]})]}):e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-graph-up display-4 mb-3"}),e.jsx("div",{children:"No Analysis Available"}),e.jsx("small",{children:"Execute a query to see execution metadata and configure charts"})]})})})},Ze=t.memo(Xe),et=({results:o,columns:r,onRowSelect:s,selectedRowIndex:l})=>{const n=t.useRef(null),a=t.useRef(null),[m,y]=t.useState(!1),[i,p]=t.useState(null),[x,S]=t.useState(null),b=t.useRef("");t.useEffect(()=>n.current?((async()=>{try{const d=document.createElement("link");d.rel="stylesheet",d.href="https://js.arcgis.com/4.29/esri/themes/light/main.css",document.head.appendChild(d);const f=new Fe({basemap:"gray-vector"}),I=new Re({container:n.current,map:f,center:[-98.5795,39.8283],zoom:4});a.current=I,await I.when(),y(!0),I.on("click",P=>{I.hitTest(P).then(K=>{if(K.results.length>0){const q=K.results[0].graphic;if(q&&q.attributes&&q.attributes.id!==void 0){const $=q.attributes.id;S($),s&&s($)}}})});const O=new Ke;f.add(O),o&&o.length>0&&_(o,r,O,!0)}catch{p("Failed to initialize map")}})(),()=>{a.current&&(a.current.destroy(),a.current=null)}):void 0,[]);const v=(c,d)=>{const f=JSON.stringify({results:c,columns:d});return btoa(f).slice(0,16)};t.useEffect(()=>{if(m&&o&&o.length>0&&a.current){const c=a.current.map.layers.find(d=>d.type==="graphics");if(c){const d=v(o,r||[]),f=d!==b.current;c.removeAll(),_(o,r||[],c,f),f&&(b.current=d)}}},[o,r,m]),t.useEffect(()=>{if(m&&a.current){const c=a.current.map.layers.find(d=>d.type==="graphics");c&&A(c,x)}},[x,m]),t.useEffect(()=>{const c=f=>{if(!(!o||o.length===0||!s)){if(f.key==="ArrowDown"){f.preventDefault();const O=Math.min((l??-1)+1,o.length-1);s(O)}else if(f.key==="ArrowUp"){f.preventDefault();const O=Math.max((l??0)-1,0);s(O)}}},d=n.current;if(d)return d.addEventListener("keydown",c),()=>d.removeEventListener("keydown",c)},[o,l,s]),t.useEffect(()=>{l!=null&&l!==x&&S(l)},[l,x]);const A=(c,d)=>{c&&c.graphics.forEach(f=>{const I=f.attributes.id===d;f.geometry.type==="point"?f.symbol=new ne({color:I?"white":"#aa0000",size:I?12:8,outline:I?{color:"#aa0000",width:2}:{color:"#aa0000",width:2},style:"circle"}):f.geometry.type==="polyline"?f.symbol=new le({color:I?"#ff0000":"#aa0000",width:I?5:3}):f.geometry.type==="polygon"&&(f.symbol=new oe({color:I?[255,0,0,.5]:[170,0,0,.3],outline:{color:I?"#ff0000":"#aa0000",width:I?3:2}}))})},_=(c,d=[],f,I=!0)=>{if(!c||c.length===0)return;const O=d.filter(P=>c.some(K=>K[P]&&typeof K[P]=="string"&&(K[P].includes("POINT")||K[P].includes("LINESTRING")||K[P].includes("POLYGON")||K[P].startsWith("point:")||K[P].startsWith("linestring:")||K[P].startsWith("polygon:"))));O.length!==0&&(c.forEach((P,K)=>{O.forEach(q=>{const $=P[q];if($)try{let h,E;if($.startsWith("point:")){const j=w($);j&&(h=new he({longitude:j.longitude,latitude:j.latitude,spatialReference:{wkid:j.crs}}),E=new ne({color:"white",size:8,outline:{color:"#aa0000",width:2},style:"circle"}))}else if($.startsWith("linestring:")){const j=C($);j&&(h=new me({paths:[j.coordinates],spatialReference:{wkid:j.crs}}),E=new le({color:"#aa0000",width:3}))}else if($.startsWith("polygon:")){const j=T($);j&&(h=new fe({rings:j.rings,spatialReference:{wkid:j.crs}}),E=new oe({color:[170,0,0,.3],outline:{color:"#aa0000",width:2}}))}else if($.includes("POINT")){const j=N($);j&&(h=new he({longitude:j[0],latitude:j[1],spatialReference:{wkid:4326}}),E=new ne({color:"white",size:8,outline:{color:"#aa0000",width:2},style:"circle"}))}else if($.includes("LINESTRING")){const j=M($);j&&(h=new me({paths:[j],spatialReference:{wkid:4326}}),E=new le({color:"#aa0000",width:3}))}else if($.includes("POLYGON")){const j=F($);j&&(h=new fe({rings:j,spatialReference:{wkid:4326}}),E=new oe({color:[170,0,0,.3],outline:{color:"#aa0000",width:2}}))}if(h&&E){const j=new ze({geometry:h,symbol:E,attributes:{id:K,...P}});f.add(j)}}catch{}})}),I&&f.graphics.length>0&&a.current?.goTo(f.graphics))},N=c=>{const d=c.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);return d?[parseFloat(d[1]),parseFloat(d[2])]:null},w=c=>{const d=c.match(/^point:\s*([-\d.]+),\s*([-\d.]+),\s*(\d+)$/i);return d?{longitude:parseFloat(d[1]),latitude:parseFloat(d[2]),crs:parseInt(d[3])}:null},C=c=>{const d=c.match(/^linestring:\s*([^,]+(?:,[^,]+)*),\s*(\d+)$/i);if(d){const f=d[1].split(",");if(f.length>=4&&f.length%2===0){const I=[];for(let O=0;O<f.length;O+=2)I.push([parseFloat(f[O]),parseFloat(f[O+1])]);return{coordinates:I,crs:parseInt(d[2])}}}return null},T=c=>{const d=c.match(/^polygon:\s*\(([^)]+)\),\s*(\d+)$/i);if(d){const f=d[1].split(",");if(f.length>=6&&f.length%2===0){const I=[];for(let O=0;O<f.length;O+=2)I.push([parseFloat(f[O]),parseFloat(f[O+1])]);return{rings:[I],crs:parseInt(d[2])}}}return null},M=c=>{const d=c.match(/LINESTRING\s*\((.*?)\)/i);return d?d[1].split(",").map(I=>{const[O,P]=I.trim().split(/\s+/);return[parseFloat(O),parseFloat(P)]}):null},F=c=>{const d=c.match(/POLYGON\s*\((.*?)\)/i);return d?d[1].split("),(").map(I=>I.replace(/[()]/g,"").split(",").map(P=>{const[K,q]=P.trim().split(/\s+/);return[parseFloat(K),parseFloat(q)]})):null};return e.jsx("div",{className:"flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},children:i?e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle display-4 mb-3"}),e.jsx("div",{children:"Map Error"}),e.jsx("small",{children:i})]})}):e.jsx("div",{ref:n,className:"flex-grow-1",style:{height:"100%",width:"100%"},tabIndex:0,onFocus:()=>{n.current&&n.current.focus()}})})},tt=t.memo(et),st=({results:o,columns:r,rowCount:s,isExecuting:l,error:n,selectedRowIndex:a,onRowSelect:m,metadata:y,spatialColumns:i=[],chartConfig:p,onChartConfigChange:x,tabId:S,className:b=""})=>{const[v,A]=t.useState("table"),_=i.some(N=>r.includes(N));return t.useEffect(()=>{v==="map"&&!_&&A("table")},[v,_]),e.jsxs("div",{className:`flex-grow-1 d-flex flex-column results-panel ${b}`,style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom",style:{flexShrink:0,paddingTop:"calc(0.5rem - 3px)",borderBottomWidth:"1px"},children:e.jsxs("div",{className:"d-flex",children:[e.jsx("div",{className:`tab-item ${v==="table"?"active":""}`,onClick:()=>A("table"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-table me-1"}),"Results",s>0&&e.jsxs("span",{className:"ms-1",children:["(",s,")"]})]})}),e.jsx("div",{className:`tab-item ${v==="analysis"?"active":""}`,onClick:()=>A("analysis"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-graph-up me-1"}),"Chart"]})}),_&&e.jsx("div",{className:`tab-item ${v==="map"?"active":""}`,onClick:()=>A("map"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-geo-alt me-1"}),"Map"]})})]})}),e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{style:{display:v==="table"?"flex":"none",height:"100%",flexDirection:"column"},children:e.jsx(We,{results:o,columns:r,rowCount:s,isExecuting:l,error:n,selectedRowIndex:a,onRowSelect:m})}),e.jsx("div",{style:{display:v==="analysis"?"flex":"none",height:"100%",flexDirection:"column",overflow:"hidden"},children:e.jsx(Ze,{metadata:y,queryResults:o,columns:r,chartConfig:p,onChartConfigChange:x||(()=>{}),tabId:S})}),_&&e.jsx("div",{style:{display:v==="map"?"flex":"none",height:"100%",flexDirection:"column"},children:e.jsx(tt,{results:o,columns:r,onRowSelect:m,selectedRowIndex:a})})]})]})},at=t.memo(st),rt=({results:o,columns:r,isExecuting:s,error:l,selectedRow:n,isCollapsed:a,onToggle:m,className:y=""})=>a?e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${y}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 d-flex justify-content-center",children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:m,title:"Expand results details",children:e.jsx("i",{className:"bi bi-chevron-left"})})}),e.jsx("div",{className:"flex-grow-1 d-flex justify-content-center align-items-center",children:e.jsx("div",{style:{writingMode:"vertical-rl",textOrientation:"mixed",transform:"rotate(360deg)",fontSize:"1rem",fontWeight:"500",color:"#aa0000"},children:"Details"})})]}):e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${y}`,style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom flex-shrink-0",style:{padding:"calc(0.3125rem + 3px) 0.5rem"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Details"]}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:m,title:"Collapse details panel",children:e.jsx("i",{className:"bi bi-chevron-right"})})]})}),e.jsxs("div",{className:"flex-grow-1 p-3",style:{overflow:"auto"},children:[n&&e.jsx("div",{children:e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-sm table-striped",style:{fontSize:"0.875rem"},children:e.jsx("tbody",{children:r.map((i,p)=>e.jsxs("tr",{children:[e.jsx("td",{className:"fw-bold text-muted",style:{width:"40%",whiteSpace:"nowrap"},children:i}),e.jsx("td",{className:"text-truncate",style:{maxWidth:"200px"},title:n[i]!==null&&n[i]!==void 0?String(n[i]):"NULL",children:n[i]!==null&&n[i]!==void 0?String(n[i]):e.jsx("span",{className:"text-muted",children:"NULL"})})]},p))})})})}),!n&&o.length>0&&e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-info-circle display-4 mb-3"}),e.jsx("div",{children:"No row selected"}),e.jsx("small",{children:"Click on a row in the results table to view its details"})]}),o.length===0&&!s&&!l&&e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-table display-4 mb-3"}),e.jsx("div",{children:"No results to display"}),e.jsx("small",{children:"Execute a query to see results"})]})]})]}),nt=t.memo(rt),lt=({schemaName:o,models:r,selectedTable:s,className:l=""})=>{const[n,a]=t.useState("");console.log("ðŸ”¥ SCHEMA DOCUMENTATION: schemaName:",o,"models count:",r.length);const m=t.useMemo(()=>{const i=[];r.forEach(x=>{const S=x.schema||x.schema_name||x.database_schema||"default";s&&x.name===s.name?x.columns&&x.columns.forEach(b=>{i.push({name:b.name,table:x.name,type:b.type||"N/A",nullable:b.nullable||!1,description:b.description,schema:S,spatial_type:b.spatial_type,semantic_role:b.semantic_role})}):s||(o==="default"||S===o)&&x.columns&&x.columns.forEach(b=>{i.push({name:b.name,table:x.name,type:b.type||"N/A",nullable:b.nullable||!1,description:b.description,schema:S,spatial_type:b.spatial_type,semantic_role:b.semantic_role})})});const p=i.sort((x,S)=>x.schema!==S.schema?x.schema.localeCompare(S.schema):x.name!==S.name?x.name.localeCompare(S.name):x.table.localeCompare(S.table));return console.log("ðŸ”¥ SCHEMA DOCUMENTATION: Found",p.length,"columns for schema:",o),p},[r,o,s]),y=t.useMemo(()=>{if(!n.trim())return m;const i=n.toLowerCase();return m.filter(p=>p.name.toLowerCase().includes(i)||p.table.toLowerCase().includes(i)||p.type.toLowerCase().includes(i)||p.description&&p.description.toLowerCase().includes(i))},[m,n]);return m.length===0?e.jsxs("div",{className:`p-4 text-center text-muted ${l}`,children:[e.jsx("i",{className:"bi bi-database fs-1 mb-3",style:{color:"#aa0000"}}),e.jsx("h5",{style:{color:"#aa0000"},children:"No Columns Found"}),e.jsxs("p",{children:["No columns available ",s?`for table "${s.name}"`:o==="default"?"in any schema":`for schema "${o}"`]})]}):e.jsxs("div",{className:`p-3 ${l}`,style:{overflow:"auto",maxHeight:"100%"},children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:`bi ${s?"bi-table":"bi-database"} me-2`,style:{color:"#aa0000"}}),e.jsx("h4",{className:"mb-0",style:{color:"#aa0000"},children:s?`Table: ${s.name}`:o==="default"?"All Schemas":`Schema: ${o}`})]}),e.jsx("div",{className:"text-muted small",children:e.jsxs("span",{className:"badge me-2",style:{backgroundColor:"#aa0000",color:"white"},children:[s?`${m.length} columns`:`${m.length} columns across ${new Set(m.map(i=>i.table)).size} tables`,!s&&o==="default"&&` in ${new Set(m.map(i=>i.schema)).size} schemas`]})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",style:{backgroundColor:"#fff5f5",borderColor:"#aa0000"},children:e.jsx("i",{className:"bi bi-search",style:{color:"#aa0000"}})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Filter columns by name, table, type, or description...",value:n,onChange:i=>a(i.target.value),style:{borderColor:"#aa0000"}})]}),n&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-muted",children:["Showing ",y.length," of ",m.length," columns"]})})]}),e.jsxs("div",{children:[e.jsxs("h6",{className:"mb-3",style:{color:"#aa0000"},children:[e.jsx("i",{className:"bi bi-table me-1",style:{color:"#aa0000"}}),"All Columns (",y.length,")"]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm table-hover",children:[e.jsx("thead",{style:{backgroundColor:"#fff5f5"},children:e.jsxs("tr",{children:[e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Column"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Table"}),o==="default"&&e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Schema"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Type"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Semantic Role"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Nullable"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Description"})]})}),e.jsx("tbody",{children:y.map((i,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{style:{color:"#aa0000"},children:i.name})}),e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsx("span",{className:"badge",style:{backgroundColor:"#f8f9fa",color:"#aa0000",border:"1px solid #aa0000",padding:"0.25em 0.4em",fontSize:"0.75em",fontWeight:"700"},children:i.table})}),o==="default"&&e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsx("span",{className:"badge",style:{backgroundColor:"#aa0000",color:"white"},children:i.schema})}),e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"badge",style:{backgroundColor:"#aa0000",color:"white"},children:i.type}),i.spatial_type&&i.spatial_type!==null&&i.spatial_type!==""&&e.jsx("span",{className:"badge ms-2",style:{backgroundColor:"transparent",color:"#aa0000",border:"1px solid #aa0000"},children:i.spatial_type})]})}),e.jsx("td",{style:{verticalAlign:"middle"},children:i.semantic_role&&i.semantic_role!==null&&i.semantic_role!==""?e.jsx("span",{className:"badge",style:{backgroundColor:"#f8f9fa",color:"#aa0000",border:"1px solid #aa0000"},children:i.semantic_role}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:i.nullable?e.jsx("span",{style:{color:"#666"},children:"Yes"}):e.jsx("span",{className:"fw-bold",style:{color:"#aa0000"},children:"No"})}),e.jsx("td",{className:"small",style:{color:"#666"},children:i.description||"-"})]},`${i.table}-${i.name}-${p}`))})]})})]})]})},ot=({isOpen:o,onClose:r,onSave:s,defaultName:l,isSaving:n=!1})=>{const[a,m]=t.useState(""),[y,i]=t.useState(""),[p,x]=t.useState(!1);t.useEffect(()=>{o&&(m(l),i(""),x(!1))},[o,l]);const S=v=>{v.preventDefault(),a.trim()&&s({name:a.trim(),description:y.trim(),isPublic:p})},b=()=>{n||r()};return o?e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-save me-2"}),"Save Query"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:b,disabled:n})]}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"queryName",className:"form-label",children:["Query Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",className:"form-control",id:"queryName",value:a,onChange:v=>m(v.target.value),placeholder:"Enter a name for your query",required:!0,disabled:n,autoFocus:!0})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"queryDescription",className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",id:"queryDescription",rows:3,value:y,onChange:v=>i(v.target.value),placeholder:"Optional description of what this query does",disabled:n})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"isPublic",checked:p,onChange:v=>x(v.target.checked),disabled:n}),e.jsxs("label",{className:"form-check-label",htmlFor:"isPublic",children:[e.jsx("i",{className:"bi bi-globe me-1"}),"Make this query public"]}),e.jsx("div",{className:"form-text",children:"Public queries can be seen and used by other users"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:b,disabled:n,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!a.trim()||n,children:n?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-save me-2"}),"Save Query"]})})]})]})]})})}):null},ie=({onResize:o,className:r=""})=>{const s=t.useRef(null),l=t.useRef(!1),n=t.useRef(0);return t.useEffect(()=>{const a=i=>{s.current?.contains(i.target)&&(l.current=!0,n.current=i.clientX,document.body.style.cursor="col-resize",document.body.style.userSelect="none",i.preventDefault())},m=i=>{if(l.current){const p=i.clientX-n.current;o(p),n.current=i.clientX}},y=()=>{l.current&&(l.current=!1,document.body.style.cursor="",document.body.style.userSelect="")};return document.addEventListener("mousedown",a),document.addEventListener("mousemove",m),document.addEventListener("mouseup",y),()=>{document.removeEventListener("mousedown",a),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",y)}},[o]),e.jsx("div",{ref:s,className:`resize-handle ${r}`,style:{width:"4px",backgroundColor:"#dee2e6",cursor:"col-resize",position:"relative",flexShrink:0},children:e.jsx("div",{style:{position:"absolute",top:0,left:"-2px",right:"-2px",bottom:0,backgroundColor:"transparent"}})})},it=({onResize:o,className:r=""})=>{const s=t.useRef(null),l=t.useRef(!1),n=t.useRef(0);return t.useEffect(()=>{const a=i=>{s.current?.contains(i.target)&&(l.current=!0,n.current=i.clientY,document.body.style.cursor="row-resize",document.body.style.userSelect="none",i.preventDefault())},m=i=>{if(l.current){const p=i.clientY-n.current;o(p),n.current=i.clientY}},y=()=>{l.current&&(l.current=!1,document.body.style.cursor="",document.body.style.userSelect="")};return document.addEventListener("mousedown",a),document.addEventListener("mousemove",m),document.addEventListener("mouseup",y),()=>{document.removeEventListener("mousedown",a),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",y)}},[o]),e.jsx("div",{ref:s,className:`horizontal-resize-handle ${r}`,style:{height:"4px",backgroundColor:"#dee2e6",cursor:"row-resize",position:"relative",flexShrink:0,width:"100%",transition:"background-color 0.2s"},children:e.jsx("div",{style:{position:"absolute",top:"-2px",left:0,right:0,bottom:"-2px",backgroundColor:"transparent"}})})},ct=({selectedTable:o,selectedSchema:r,models:s=[],spatialColumns:l=[],selectedQuery:n,generatedSql:a,onTableSelect:m,onSchemaSelect:y,onModelsLoaded:i,onGenerateSelect:p,onSpatialColumnsLoaded:x,onTableDocumentationSelect:S,onSqlGenerated:b,onQueryLoaded:v,onSqlLoaded:A,onQuerySaved:_,className:N=""})=>{const[w,C]=t.useState([{id:"docs",name:"ðŸ“‹ Models",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}},{id:"1",name:"Query 1",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}}]),[T,M]=t.useState("1"),[F,c]=t.useState(2),[d,f]=t.useState(!1),[I,O]=t.useState(!0),[P,K]=t.useState(300),[q,$]=t.useState(50),[h,E]=t.useState(!1),[j,z]=t.useState(!1),L=t.useRef(null),R=t.useRef("1"),D=t.useRef([{id:"docs",name:"ðŸ“‹ Models",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}},{id:"1",name:"Query 1",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}}]);t.useEffect(()=>{R.current=T},[T]),t.useEffect(()=>{D.current=w},[w]),t.useEffect(()=>{if(n){const u={id:F.toString(),name:n.name||"Saved Query",queryText:n.sqlText||"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:n.chartConfig||null},originalQuery:n};C(g=>[...g,u]),c(g=>g+1),M(u.id),v&&v()}},[n,F,v]),t.useEffect(()=>{r&&(console.log("ðŸ”¥ SIMPLE TAB MANAGER: Schema selected, switching to docs tab:",r),M("docs"))},[r]),t.useEffect(()=>{a&&(console.log("ðŸ”¥ SIMPLE TAB MANAGER: Generated SQL received:",a),C(u=>u.map(g=>g.id===T?{...g,queryText:a}:g)),A&&A())},[a,T,A]);const J=t.useMemo(()=>new ce,[]),B=w.find(u=>u.id===T);console.log("ðŸ”¥ SIMPLE TAB MANAGER RENDER: activeTabId:",T,"selectedSchema:",r),t.useEffect(()=>{if(L.current&&s.length>0){L.current.completionProvider&&(L.current.completionProvider.dispose(),L.current.completionProvider=null);const u=window.monaco;if(u){const g=u.languages.registerCompletionItemProvider("sql",{triggerCharacters:[" ",".",",","(",")","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],provideCompletionItems:(k,U)=>{const G=k.getWordUntilPosition(U),W={startLineNumber:U.lineNumber,endLineNumber:U.lineNumber,startColumn:G.startColumn,endColumn:G.endColumn},X=[];[{label:"SELECT",kind:u.languages.CompletionItemKind.Keyword,insertText:"SELECT",documentation:"Select data from tables"},{label:"FROM",kind:u.languages.CompletionItemKind.Keyword,insertText:"FROM",documentation:"Specify the source table(s)"},{label:"WHERE",kind:u.languages.CompletionItemKind.Keyword,insertText:"WHERE",documentation:"Filter rows based on conditions"},{label:"INSERT",kind:u.languages.CompletionItemKind.Keyword,insertText:"INSERT",documentation:"Insert new rows into a table"},{label:"UPDATE",kind:u.languages.CompletionItemKind.Keyword,insertText:"UPDATE",documentation:"Modify existing rows"},{label:"DELETE",kind:u.languages.CompletionItemKind.Keyword,insertText:"DELETE",documentation:"Remove rows from a table"},{label:"CREATE",kind:u.languages.CompletionItemKind.Keyword,insertText:"CREATE",documentation:"Create database objects"},{label:"DROP",kind:u.languages.CompletionItemKind.Keyword,insertText:"DROP",documentation:"Remove database objects"},{label:"ALTER",kind:u.languages.CompletionItemKind.Keyword,insertText:"ALTER",documentation:"Modify database objects"},{label:"JOIN",kind:u.languages.CompletionItemKind.Keyword,insertText:"JOIN",documentation:"Join tables together"},{label:"INNER JOIN",kind:u.languages.CompletionItemKind.Keyword,insertText:"INNER JOIN",documentation:"Inner join tables"},{label:"LEFT JOIN",kind:u.languages.CompletionItemKind.Keyword,insertText:"LEFT JOIN",documentation:"Left outer join tables"},{label:"RIGHT JOIN",kind:u.languages.CompletionItemKind.Keyword,insertText:"RIGHT JOIN",documentation:"Right outer join tables"},{label:"ORDER BY",kind:u.languages.CompletionItemKind.Keyword,insertText:"ORDER BY",documentation:"Sort the result set"},{label:"GROUP BY",kind:u.languages.CompletionItemKind.Keyword,insertText:"GROUP BY",documentation:"Group rows by columns"},{label:"HAVING",kind:u.languages.CompletionItemKind.Keyword,insertText:"HAVING",documentation:"Filter groups"},{label:"UNION",kind:u.languages.CompletionItemKind.Keyword,insertText:"UNION",documentation:"Combine result sets"},{label:"DISTINCT",kind:u.languages.CompletionItemKind.Keyword,insertText:"DISTINCT",documentation:"Remove duplicate rows"},{label:"LIMIT",kind:u.languages.CompletionItemKind.Keyword,insertText:"LIMIT",documentation:"Limit the number of rows returned"},{label:"OFFSET",kind:u.languages.CompletionItemKind.Keyword,insertText:"OFFSET",documentation:"Skip a number of rows"}].forEach(Q=>{X.push({...Q,range:W})});const de=k.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:U.lineNumber,endColumn:U.column}),ue=de.match(/([a-zA-Z_$][\w$]*)\s*\.\s*$/i);let se=!1,Z=null,ae=null;if(ue){const Q=ue[1];se=!0;const H=new Map,V=de.matchAll(/(?:FROM|JOIN)\s+([a-zA-Z_$][\w$]*\.?[a-zA-Z_$][\w$]*)\s+(?:AS\s+)?([a-zA-Z_$][\w$]*)/gi);for(const ee of V){const Ae=ee[1],Me=ee[2];H.set(Me,Ae)}H.has(Q)?(ae=Q,Z=H.get(Q)):Z=Q}if(s&&s.length>0&&!se&&s.forEach(Q=>{const H=Q.schema||Q.schema_name||Q.database_schema||"default",V=Q.name||Q.table_name;V&&(X.push({label:V,kind:u.languages.CompletionItemKind.Class,insertText:V,documentation:`Table: ${V} (Schema: ${H})`,detail:`Table in ${H} schema`,range:W}),X.push({label:`${H}.${V}`,kind:u.languages.CompletionItemKind.Class,insertText:`${H}.${V}`,documentation:`Table: ${V} (Schema: ${H})`,detail:"Fully qualified table name",range:W}))}),se&&Z&&s&&s.length>0){const Q=s.find(H=>{const V=H.schema||H.schema_name||H.database_schema||"default",ee=H.name||H.table_name;return ee===Z||`${V}.${ee}`===Z});Q&&Q.columns&&Array.isArray(Q.columns)&&Q.columns.forEach(H=>{X.push({label:H.name,kind:u.languages.CompletionItemKind.Field,insertText:H.name,documentation:`Column: ${H.name} (Type: ${H.type})${ae?` from alias ${ae}`:""}`,detail:`${H.type}${H.nullable?" (nullable)":" (not null)"}`,range:W})})}return{suggestions:X}}});L.current.completionProvider=g}}return()=>{L.current&&L.current.completionProvider&&(L.current.completionProvider.dispose(),L.current.completionProvider=null)}},[s]);const ge=t.useCallback(()=>{const u={id:F.toString(),name:`Query ${F}`,queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}};C(g=>[...g,u]),c(g=>g+1),M(u.id)},[F]),be=t.useCallback(u=>{if(u==="docs")return;if(w.length<=2){const k={id:F.toString(),name:`Query ${F}`,queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}};C(U=>[...U.filter(G=>G.id==="docs"),k]),c(U=>U+1),M(k.id);return}const g=w.filter(k=>k.id!==u);if(C(g),T===u){const k=w.findIndex(W=>W.id===u),U=k>0?k-1:0,G=g[U].id;M(G)}},[w,T,F]),ye=t.useCallback(u=>{M(u)},[]),je=t.useCallback(u=>{C(g=>g.map(k=>k.id===T?{...k,queryText:u}:k))},[T]),te=t.useCallback(async(u,g)=>{f(!0);try{const k=await J.executeSql(u);k.success&&k.data?C(U=>U.map(G=>G.id===g?{...G,results:{results:k.data.data||[],columns:k.data.columns||[],rowCount:k.data.row_count||0,executionError:null,executionMetadata:k.data.metadata||null,selectedRowIndex:null,chartConfig:null}}:G)):C(U=>U.map(G=>G.id===g?{...G,results:{...G.results,executionError:k.error||"Failed to execute query",results:[],columns:[],rowCount:0,selectedRowIndex:null}}:G))}catch(k){const U=k instanceof Error?k.message:"Unknown error occurred";C(G=>G.map(W=>W.id===g?{...W,results:{...W.results,executionError:U,results:[],columns:[],rowCount:0,selectedRowIndex:null}}:W))}finally{f(!1)}},[J]),ve=t.useCallback(async u=>{let g=u;if(!g&&L.current){const k=L.current.getSelection();k&&!k.isEmpty()?g=L.current.getModel()?.getValueInRange(k)||"":g=L.current.getValue()||""}g||(g=B?.queryText||""),await te(g,T)},[T,B?.queryText,te]),Ne=t.useCallback(u=>{C(g=>g.map(k=>k.id===T?{...k,results:{...k.results,selectedRowIndex:u}}:k))},[T]),we=t.useCallback(u=>{C(g=>g.map(k=>k.id===T?{...k,results:{...k.results,chartConfig:u?{...u}:null}}:k))},[T]),ke=t.useCallback(u=>{K(g=>Math.max(150,Math.min(500,g+u)))},[]),Se=t.useCallback(()=>{O(u=>!u)},[]),Ce=t.useCallback(u=>{$(g=>{const k=g+u/window.innerHeight*100;return Math.max(20,Math.min(80,k))})},[]),Te=t.useCallback(async()=>{if(T==="docs")return;const u=w.find(g=>g.id===T);if(u)if(u.originalQuery){z(!0);try{const g={guid:u.originalQuery.guid,name:u.originalQuery.name,description:u.originalQuery.description,sqlText:u.queryText,chartConfig:u.results.chartConfig,isPublic:u.originalQuery.isPublic},k=await J.saveQuery(g);if(k.success)console.log("Query saved successfully"),_&&_();else throw new Error(k.error||"Failed to save query")}catch(g){console.error("Error saving query:",g)}finally{z(!1)}}else E(!0)},[T,w,J,_]),Ee=t.useCallback(async u=>{if(T!=="docs"){z(!0);try{const g=w.find(G=>G.id===T);if(!g)throw new Error("No active tab found");const k={guid:crypto.randomUUID(),name:u.name,description:u.description,sqlText:g.queryText,chartConfig:g.results.chartConfig,isPublic:u.isPublic},U=await J.saveQuery(k);if(U.success)E(!1),_&&_();else throw new Error(U.error||"Failed to save query")}catch(g){console.error("Error saving query:",g)}finally{z(!1)}}},[T,w,J,_]),Ie=t.useCallback(()=>{j||E(!1)},[j]),_e=t.useMemo(()=>B?.results.selectedRowIndex!==null&&B?.results.results?B.results.results[B.results.selectedRowIndex]:null,[B?.results.selectedRowIndex,B?.results.results]);return e.jsxs("div",{className:`d-flex flex-column h-100 ${N}`,style:{overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom",style:{flexShrink:0,paddingTop:"calc(0.5rem - 3px)",borderBottomWidth:"1px"},children:e.jsx("div",{className:"d-flex align-items-center",children:e.jsxs("div",{className:"tab-scroll-container d-flex flex-grow-1",style:{overflow:"hidden"},children:[w.map(u=>e.jsxs("div",{className:`tab-item ${T===u.id?"active":""}`,onClick:()=>ye(u.id),children:[e.jsx("span",{className:"tab-name",children:u.name}),u.id!=="docs"&&e.jsx("button",{className:"tab-close",onClick:g=>{g.stopPropagation(),be(u.id)},children:e.jsx("i",{className:"bi bi-x"})})]},u.id)),e.jsx("div",{className:"tab-item new-tab-tab",onClick:ge,title:"New Query",children:e.jsx("i",{className:"bi bi-plus"})})]})})}),e.jsx("div",{className:"flex-grow-1 d-flex flex-column",style:{minHeight:0,position:"relative",overflow:"hidden"},children:T==="docs"?e.jsx("div",{className:"flex-grow-1",style:{overflow:"auto",maxHeight:"100%"},children:e.jsx(lt,{schemaName:r||"default",models:s,selectedTable:o,className:"h-100"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{height:`${q}%`,minHeight:0},children:e.jsxs("div",{className:"bg-light border-start d-flex flex-column h-100",style:{overflow:"hidden"},children:[e.jsx("div",{className:"flex-grow-1",style:{height:"100%",overflow:"hidden"},children:e.jsx(Pe,{height:"100%",language:"sql",value:B?.queryText||"",onChange:u=>je(u||""),onMount:(u,g)=>{L.current=u,g.languages.register({id:"sql"}),g.languages.setMonarchTokensProvider("sql",{tokenizer:{root:[[/[a-zA-Z_$][\w$]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d*\.\d+([eE][\-+]?\d+)?[fFdD]?/,"number.float"],[/0[xX][0-9a-fA-F]+[Ll]?/,"number.hex"],[/\d+[lL]?/,"number"],[/[;,.]/,"delimiter"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/\/\*/,"comment","@comment"],[/--.*$/,"comment"]],string_double:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/\\./,"string.escape"],[/'/,"string","@pop"]],comment:[[/[^\/*]+/,"comment"],[/\*\//,"comment","@pop"],[/[\/*]/,"comment"]]},keywords:["SELECT","FROM","WHERE","INSERT","UPDATE","DELETE","CREATE","DROP","ALTER","TABLE","INDEX","VIEW","PROCEDURE","FUNCTION","TRIGGER","DATABASE","SCHEMA","JOIN","INNER","LEFT","RIGHT","OUTER","ON","AS","AND","OR","NOT","IN","EXISTS","BETWEEN","LIKE","IS","NULL","ORDER","BY","GROUP","HAVING","UNION","ALL","DISTINCT","TOP","LIMIT","OFFSET","ASC","DESC","INT","VARCHAR","CHAR","TEXT","DECIMAL","FLOAT","DOUBLE","DATE","TIME","DATETIME","TIMESTAMP","BOOLEAN","BLOB","JSON"]}),u.addCommand(g.KeyMod.CtrlCmd|g.KeyCode.Enter,()=>{const k=R.current;if(k!=="docs"){const U=u.getValue()||"";C(G=>G.map(W=>W.id===k?{...W,queryText:U}:W)),te(U,k)}}),u.addCommand(g.KeyMod.CtrlCmd|g.KeyCode.Space,()=>{u.trigger("","editor.action.triggerSuggest",{})})},options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"on",wordWrap:"on",folding:!0,lineDecorationsWidth:10,lineNumbersMinChars:3,renderLineHighlight:"all",scrollbar:{vertical:"auto",horizontal:"auto",verticalScrollbarSize:8,horizontalScrollbarSize:8},suggest:{showKeywords:!0,showSnippets:!0,showFunctions:!0,showConstructors:!0,showFields:!0,showVariables:!0,showClasses:!0,showStructs:!0,showInterfaces:!0,showModules:!0,showProperties:!0,showEvents:!0,showOperators:!0,showUnits:!0,showValues:!0,showConstants:!0,showEnums:!0,showEnumMembers:!0,showColors:!0,showFiles:!0,showReferences:!0,showFolders:!0,showTypeParameters:!0,showIssues:!0,showUsers:!0,showWords:!0},quickSuggestions:{other:!0,comments:!1,strings:!1},parameterHints:{enabled:!0},hover:{enabled:!0},contextmenu:!0,mouseWheelZoom:!0,multiCursorModifier:"ctrlCmd",formatOnPaste:!0,formatOnType:!0},theme:"vs"})}),e.jsx("div",{className:"p-3 border-top",style:{flexShrink:0},children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:()=>ve(),children:[e.jsx("i",{className:"bi bi-play me-1"}),"Execute"]}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:Te,disabled:T==="docs"||j,children:j?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-save me-1"}),"Save"]})}),e.jsxs("button",{className:"btn btn-outline-secondary",children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-1"}),"Format"]})]})})]})}),e.jsx(it,{onResize:Ce}),e.jsxs("div",{className:"d-flex",style:{height:`${100-q}%`,minHeight:"200px"},children:[e.jsx("div",{className:"flex-grow-1",style:{minWidth:0,height:"100%"},children:e.jsx(at,{results:B?.results.results||[],columns:B?.results.columns||[],rowCount:B?.results.rowCount||0,isExecuting:d,error:B?.results.executionError||null,selectedRowIndex:B?.results.selectedRowIndex||null,onRowSelect:Ne,metadata:B?.results.executionMetadata||null,spatialColumns:l,chartConfig:B?.results.chartConfig||null,onChartConfigChange:we,tabId:T,className:"h-100"})}),!I&&e.jsx(ie,{onResize:ke}),e.jsx("div",{style:{width:I?"40px":`${P}px`,flexShrink:0,transition:"width 0.3s ease"},children:e.jsx(nt,{results:B?.results.results||[],columns:B?.results.columns||[],rowCount:B?.results.rowCount||0,isExecuting:d,error:B?.results.executionError||null,selectedRow:_e,isCollapsed:I,onToggle:Se})})]})]})}),e.jsx(ot,{isOpen:h,onClose:Ie,onSave:Ee,defaultName:B?.name||"New Query",isSaving:j})]})},dt=({className:o="",onSqlGenerated:r,isCollapsed:s=!1,onToggle:l})=>{const[n,a]=t.useState([]),[m,y]=t.useState(""),[i,p]=t.useState(!1),x=t.useRef(null),S=new ce;t.useEffect(()=>{x.current&&(x.current.scrollTop=x.current.scrollHeight)},[n]);const b=async()=>{if(m.trim()&&!i){const _={id:Date.now(),text:m,sender:"user"};a(N=>[...N,_]),y(""),p(!0);try{const N=await S.sendPrompt(m);if(N.success&&N.data)if(N.data.sql){r&&r(N.data.sql);const w={id:Date.now()+1,text:r?"Your SQL is in the query editor.":`Generated SQL:
\`\`\`sql
${N.data.sql}
\`\`\``,sender:"ai"};a(C=>[...C,w])}else{const w=JSON.stringify(N.data,null,2),C={id:Date.now()+1,text:`**Data Service Response:**
\`\`\`json
${w}
\`\`\``,sender:"ai"};a(T=>[...T,C])}else{const w={id:Date.now()+1,text:`**Error:** ${N.error||"Failed to get response from data service"}`,sender:"ai"};a(C=>[...C,w])}}catch(N){const w={id:Date.now()+1,text:`**Error:** ${N instanceof Error?N.message:"Unknown error occurred"}`,sender:"ai"};a(C=>[...C,w])}finally{p(!1)}}},v=_=>{_.key==="Enter"&&!_.shiftKey&&(_.preventDefault(),b())},A=()=>{a([])};return s?e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${o}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 d-flex justify-content-center",children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:l,title:"Expand chat panel",children:e.jsx("i",{className:"bi bi-chevron-left"})})}),e.jsx("div",{className:"flex-grow-1 d-flex justify-content-center align-items-center",children:e.jsx("div",{style:{writingMode:"vertical-rl",textOrientation:"mixed",transform:"rotate(360deg)",fontSize:"1rem",fontWeight:"500",color:"#aa0000"},children:"AI Assistant"})})]}):e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${o}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 panel-header",style:{background:"linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)",borderBottomWidth:"2px"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"text-muted mb-0 d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-chat-dots me-2"}),"AI Assistant"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:A,disabled:n.length===0,title:"Clear chat history",children:e.jsx("i",{className:"bi bi-trash"})}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:l,title:"Collapse chat panel",children:e.jsx("i",{className:"bi bi-chevron-right"})})]})]})}),e.jsx("div",{ref:x,className:"flex-grow-1 p-3 overflow-auto chat-panel-scroll d-flex flex-column",children:e.jsxs("div",{className:"flex-grow-1",children:[n.map(_=>e.jsx("div",{className:`mb-3 ${_.sender==="user"?"text-end":"text-start"}`,children:e.jsx("div",{className:`d-inline-block p-2 rounded ${_.sender==="user"?"text-white":"bg-white border"}`,style:_.sender==="user"?{backgroundColor:"#aa0000"}:{},children:_.text})},_.id)),i&&e.jsx("div",{className:"mb-3 text-start",children:e.jsxs("div",{className:"d-inline-block p-2 rounded bg-white border",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-danger me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("span",{className:"text-muted",children:"Generating response..."})]}),e.jsx("div",{className:"progress mt-2",style:{height:"4px"},children:e.jsx("div",{className:"progress-bar bg-danger",role:"progressbar",style:{width:"100%",animation:"progress-bar-stripes 1s linear infinite"}})})]})})]})}),e.jsx("div",{className:"p-3 border-top flex-shrink-0",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("textarea",{className:"form-control flex-grow-1",placeholder:i?"Almost there...":"redfive standing by...",value:m,onChange:_=>y(_.target.value),onKeyPress:v,disabled:i,rows:3,style:{resize:"vertical",minHeight:"75px"}}),e.jsx("button",{className:"btn align-self-start",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white",marginTop:"2px"},onClick:b,disabled:i||!m.trim(),children:i?e.jsx("i",{className:"bi bi-hourglass-split"}):e.jsx("i",{className:"bi bi-send"})})]})})]})};function ut(){const[o,r]=t.useState(312),[s,l]=t.useState(437),n=150,a=500,[m,y]=t.useState([]),[i,p]=t.useState(null),[x,S]=t.useState(null),[b,v]=t.useState([]),[A,_]=t.useState(null),[N,w]=t.useState(null),[C,T]=t.useState(!1),[M,F]=t.useState(null);x&&console.log("App state - selectedSchema:",x);const c=t.useCallback(D=>{r(J=>Math.max(n,Math.min(a,J+D)))},[n,a]),d=t.useCallback(D=>{l(J=>Math.max(n,Math.min(a,J-D)))},[n,a]),f=t.useCallback(D=>{p(D)},[]),I=t.useCallback(D=>{console.log("ðŸ”¥ APP: Schema selected:",D),S(D),p(null)},[]),O=t.useCallback(D=>{y(D)},[]),P=t.useCallback(()=>{},[]),K=t.useCallback(D=>{v(D)},[]),q=t.useCallback(D=>{p(D)},[]),$=t.useCallback(D=>{w(D)},[]),h=t.useCallback(D=>{_(D)},[]),E=t.useCallback(()=>{_(null)},[]),j=t.useCallback(()=>{console.log("ðŸ”¥ APP: SQL loaded, clearing generatedSql"),w(null)},[]),z=t.useCallback(()=>{T(D=>!D)},[]),L=t.useCallback(()=>{M&&M()},[M]),R=t.useCallback(D=>{F(()=>D)},[]);return e.jsx(qe,{children:e.jsx(Ue,{children:e.jsxs("div",{className:"d-flex flex-column",style:{height:"100vh",margin:0,padding:0},children:[e.jsx(He,{}),e.jsxs("div",{className:"flex-grow-1 d-flex",style:{height:"calc(100vh - 56px)",overflow:"hidden"},children:[e.jsx("div",{style:{width:`${o}px`,flexShrink:0,height:"100%"},children:e.jsx(Ge,{onTableSelect:f,onSchemaSelect:I,onModelsLoaded:O,onGenerateSelect:P,onSpatialColumnsLoaded:K,onTableDocumentationSelect:q,onQuerySelect:h,onRefreshQueries:R})}),e.jsx(ie,{onResize:c}),e.jsx("div",{className:"flex-grow-1",style:{minWidth:0},children:e.jsx(ct,{selectedTable:i,selectedSchema:x||void 0,models:m,spatialColumns:b,onTableSelect:f,onSchemaSelect:I,onModelsLoaded:O,onGenerateSelect:P,onSpatialColumnsLoaded:K,onTableDocumentationSelect:q,onSqlGenerated:$,selectedQuery:A,onQueryLoaded:E,generatedSql:N,onSqlLoaded:j,onQuerySaved:L,className:"h-100"})}),e.jsx(ie,{onResize:d}),e.jsx("div",{style:{width:C?"40px":`${s}px`,flexShrink:0,transition:"width 0.3s ease"},children:e.jsx(dt,{onSqlGenerated:$,isCollapsed:C,onToggle:z})})]})]})})})}De.createRoot(document.getElementById("root")).render(e.jsx(t.StrictMode,{children:e.jsx(ut,{})}));
