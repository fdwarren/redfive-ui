var $e=Object.defineProperty;var De=(i,t,n)=>t in i?$e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[t]=n;var H=(i,t,n)=>De(i,typeof t!="symbol"?t+"":t,n);import{t as o,v as e,w as qe,x as oe,y as Pe,z as Ke}from"./vendor-CCNNoD4t.js";import{u as le,m as ce,a as de,_ as fe,y as xe,P as ge,b as Re,L as ze,p as Fe,n as Ue}from"./esri-CRwOYz7w.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const h of l.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function n(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(r){if(r.ep)return;r.ep=!0;const l=n(r);fetch(r.href,l)}})();const B=()=>"https://redfive-api-1092564995915.us-central1.run.app",pe=o.createContext(void 0),be=()=>{const i=o.useContext(pe);if(i===void 0)throw new Error("useAuth must be used within an AuthProvider");return i},Qe=({children:i})=>{const[t,n]=o.useState(null),[a,r]=o.useState(!0),[l,h]=o.useState(!1);o.useEffect(()=>{if(window.google&&window.google.accounts){r(!1);return}if(document.querySelector('script[src="https://accounts.google.com/gsi/client"]')){const I=()=>{window.google&&window.google.accounts?r(!1):setTimeout(I,100)};I();return}const T=()=>{window.google&&window.google.accounts?r(!1):setTimeout(T,100)},j=document.createElement("script");j.src="https://accounts.google.com/gsi/client",j.async=!0,j.defer=!0,j.onload=T,j.onerror=()=>{r(!1)},document.head.appendChild(j);const C=localStorage.getItem("user"),$=localStorage.getItem("access_token");if(C&&$)try{(w=>{try{const _=JSON.parse(atob(w.split(".")[1])),P=Date.now()/1e3;return _.exp<P}catch{return!0}})($)?setTimeout(async()=>{const w=localStorage.getItem("refresh_token");if(w){const _=B();try{const P=await fetch(`${_}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refresh_token:w})});if(P.ok){const K=await P.json();K.access_token&&(localStorage.setItem("access_token",K.access_token),K.refresh_token&&localStorage.setItem("refresh_token",K.refresh_token),n(JSON.parse(C)))}else localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}catch{localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}}else localStorage.removeItem("user"),localStorage.removeItem("access_token")},100):n(JSON.parse(C))}catch{localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}return()=>{const I=document.querySelector('script[src="https://accounts.google.com/gsi/client"]');I&&I.remove()}},[]);const g={user:t,isAuthenticated:!!t,isLoading:a,login:()=>{if(l||!window.google||!window.google.accounts)return;const S="1092564995915-914iml3sjt13lcb6c038cniqe72374h9.apps.googleusercontent.com";h(!0),window.google.accounts.oauth2.initTokenClient({client_id:S,scope:"openid profile email",ux_mode:"redirect",redirect_uri:window.location.origin,callback:j=>{j.access_token?fetch(`https://www.googleapis.com/oauth2/v2/userinfo?access_token=${j.access_token}`).then(C=>C.json()).then(C=>{const $=B();return fetch(`${$}/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({access_token:j.access_token,user_info:C})}).then(I=>I.json()).then(I=>{if(I.success||I.user){const w={id:I.user?.id||C.id,name:I.user?.name||C.name,email:I.user?.email||C.email,picture:I.user?.picture||C.picture};n(w),localStorage.setItem("user",JSON.stringify(w))}h(!1)})}).catch(()=>{h(!1)}):h(!1)}}).requestAccessToken()},logout:()=>{const S=B();fetch(`${S}/auth/logout`,{method:"POST",credentials:"include"}).catch(()=>{}),n(null),h(!1),localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),window.google&&window.google.accounts&&window.google.accounts.oauth2.revoke()},refreshToken:async()=>{try{const S=localStorage.getItem("refresh_token");if(!S)return!1;const T=B(),j=await fetch(`${T}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refresh_token:S})});if(!j.ok)return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),n(null),!1;const C=await j.json();return C.access_token?(localStorage.setItem("access_token",C.access_token),C.refresh_token&&localStorage.setItem("refresh_token",C.refresh_token),!0):!1}catch{return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),n(null),!1}}};return e.jsx(pe.Provider,{value:g,children:i})},He=({children:i})=>{const{isAuthenticated:t,isLoading:n}=be(),a=o.useRef(null),r=o.useRef(!1),[l,h]=o.useState(!1);return o.useEffect(()=>{if(!r.current&&!n&&!t&&window.google&&window.google.accounts&&a.current){const b="1092564995915-914iml3sjt13lcb6c038cniqe72374h9.apps.googleusercontent.com";r.current=!0,a.current&&(a.current.innerHTML=""),window.google.accounts.id.initialize({client_id:b,callback:c=>{if(c.credential){h(!0);const u=JSON.parse(atob(c.credential.split(".")[1])),g=B();fetch(`${g}/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({token:c.credential})}).then(S=>S.ok?S.json():S.json().then(T=>{throw new Error(`Server error: ${JSON.stringify(T)}`)})).then(S=>{if(S.access_token){localStorage.setItem("access_token",S.access_token),localStorage.setItem("refresh_token",S.refresh_token);const T={id:u.sub,name:u.name,email:u.email,picture:u.picture};localStorage.setItem("user",JSON.stringify(T)),setTimeout(()=>{window.location.reload()},1e3)}}).catch(()=>{h(!1)})}}}),window.google.accounts.id.renderButton(a.current,{theme:"outline",size:"large",text:"signin_with",shape:"rectangular"})}},[n,t]),o.useEffect(()=>()=>{r.current=!1},[]),n?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"spinner-border text-primary mb-3",role:"status",style:{width:"3rem",height:"3rem"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("h4",{children:"Initializing..."}),e.jsx("p",{className:"text-muted",children:"Setting up authentication"})]})}):l?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"spinner-border text-primary mb-3",role:"status",style:{width:"3rem",height:"3rem"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("h4",{children:"Authenticating..."}),e.jsx("p",{className:"text-muted",children:"Please wait while we verify your identity"})]})}):t?e.jsx(e.Fragment,{children:i}):e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh",backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h1",{className:"display-4 fw-bold",style:{color:"#aa0000"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("p",{className:"lead text-muted",children:"Data Analytics Workbench"})]}),e.jsx("div",{className:"card shadow-lg border-0",style:{maxWidth:"400px",margin:"0 auto"},children:e.jsxs("div",{className:"card-body p-5",children:[e.jsx("h4",{className:"card-title text-center mb-4",children:"Welcome"}),e.jsx("p",{className:"text-muted text-center mb-4",children:"Sign in with your Google account to continue"}),e.jsx("div",{ref:a,className:"d-flex justify-content-center"})]})}),e.jsx("div",{className:"mt-4",children:e.jsx("small",{className:"text-muted",children:"Secure authentication powered by Google"})})]})})},Ge=()=>{const{user:i,isAuthenticated:t,isLoading:n,login:a,logout:r}=be(),l=()=>{a()},h=()=>{r()};return e.jsx("nav",{className:"navbar navbar-expand-lg navbar-dark",style:{flexShrink:0,padding:"0px",backgroundColor:"#aa0000"},children:e.jsxs("div",{className:"container-fluid",children:[e.jsxs("a",{className:"navbar-brand fw-bold",href:"#",style:{color:"white",fontSize:"21pt",lineHeight:"1",padding:"0",margin:"0"},children:[e.jsx("span",{children:"red"}),e.jsx("span",{style:{fontStyle:"italic",opacity:.9},children:"five"})]}),e.jsx("div",{className:"navbar-nav ms-auto",children:n?e.jsxs("div",{className:"nav-link",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Loading..."]}):t&&i?e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"nav-link btn btn-link text-light text-decoration-none",onClick:h,style:{border:"none",background:"none"},children:[e.jsx("i",{className:"bi bi-box-arrow-right me-1"}),"Logout"]}),e.jsxs("div",{className:"nav-link d-flex align-items-right",children:[i.picture&&e.jsx("img",{src:i.picture,alt:i.name,className:"rounded-circle me-2",style:{width:"24px",height:"24px"}}),e.jsx("span",{className:"me-3",children:i.name})]})]}):e.jsxs("button",{className:"nav-link btn btn-link text-light text-decoration-none",onClick:l,style:{border:"none",background:"none"},children:[e.jsx("i",{className:"bi bi-google me-1"}),"Login with Google"]})})]})})},ee=class ee{constructor(){H(this,"baseUrl");this.baseUrl=B()}async sendPrompt(t,n){const a={query:t,history:n};console.log("History:",n);const r={"Content-Type":"application/json",Accept:"application/json"},l=await this.getValidToken();l&&(r.Authorization=`Bearer ${l}`);const h=await fetch(`${this.baseUrl}/generate-sql`,{method:"POST",headers:r,body:JSON.stringify(a),mode:"cors",credentials:"include",cache:"no-cache"});if(!h.ok){const b=await h.text();throw new Error(`HTTP error! status: ${h.status} - ${b}`)}return await h.json()}async executeSql(t){const n={sql:t},a={"Content-Type":"application/json",Accept:"application/json"},r=await this.getValidToken();r&&(a.Authorization=`Bearer ${r}`);const l=await fetch(`${this.baseUrl}/execute-sql`,{method:"POST",headers:a,body:JSON.stringify(n),mode:"cors",credentials:"include",cache:"no-cache"});if(!l.ok){const h=await l.text();throw new Error(`HTTP error! status: ${l.status} - ${h}`)}return await l.json()}async listModels(){const t={"Content-Type":"application/json",Accept:"application/json"},n=await this.getValidToken();n&&(t.Authorization=`Bearer ${n}`);const a=await fetch(`${this.baseUrl}/list-models`,{method:"GET",headers:t,mode:"cors",credentials:"include",cache:"no-cache"});if(!a.ok){const l=await a.text();throw new Error(`HTTP error! status: ${a.status} - ${l}`)}return(await a.json()).models}async refreshToken(){try{const t=localStorage.getItem("refresh_token");if(!t)return{success:!1,error:"No refresh token available",message:"Please log in again"};const n={"Content-Type":"application/json",Accept:"application/json"},a=await fetch(`${this.baseUrl}/auth/refresh`,{method:"POST",headers:n,body:JSON.stringify({refresh_token:t}),mode:"cors",credentials:"include",cache:"no-cache"});if(!a.ok){const l=await a.text();return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),{success:!1,error:`Token refresh failed: ${l}`,message:"Please log in again"}}const r=await a.json();return r.access_token&&(localStorage.setItem("access_token",r.access_token),r.refresh_token&&localStorage.setItem("refresh_token",r.refresh_token)),{success:!0,data:r,message:"Token refreshed successfully"}}catch(t){return localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred",message:"Token refresh failed, please log in again"}}}isTokenExpired(t){try{const n=JSON.parse(atob(t.split(".")[1])),a=Date.now()/1e3;return n.exp<a}catch{return!0}}async getValidToken(){const t=localStorage.getItem("access_token");if(!t)return null;if(this.isTokenExpired(t)){const n=await this.refreshToken();return n.success&&n.data?.access_token?n.data.access_token:null}return t}async saveQuery(t){const n={"Content-Type":"application/json",Accept:"application/json"},a=await this.getValidToken();a&&(n.Authorization=`Bearer ${a}`);const r=await fetch(`${this.baseUrl}/save-query`,{method:"POST",headers:n,body:JSON.stringify(t),mode:"cors",credentials:"include",cache:"no-cache"});if(!r.ok){const h=await r.text();throw new Error(`HTTP error! status: ${r.status} - ${h}`)}return await r.json()}async listQueries(){console.log("DataService.listQueries: Making request to:",`${this.baseUrl}/list-queries`);const t={"Content-Type":"application/json",Accept:"application/json"},n=await this.getValidToken();console.log("DataService.listQueries: Access token available:",!!n),n&&(t.Authorization=`Bearer ${n}`);const a=await fetch(`${this.baseUrl}/list-queries`,{method:"GET",headers:t,mode:"cors",credentials:"include",cache:"no-cache"});if(console.log("DataService.listQueries: Response status:",a.status),!a.ok){const l=await a.text();throw console.error("DataService.listQueries: Error response:",l),new Error(`HTTP error! status: ${a.status} - ${l}`)}const r=await a.json();return console.log("DataService.listQueries: Response data:",r),r.queries}async deleteQuery(t){console.log("DataService.deleteQuery: Making request to:",`${this.baseUrl}/delete-query/${t}`);const n={"Content-Type":"application/json",Accept:"application/json"},a=await this.getValidToken();a&&(n.Authorization=`Bearer ${a}`);const r=await fetch(`${this.baseUrl}/delete-query/${t}`,{method:"DELETE",headers:n,mode:"cors",credentials:"include",cache:"no-cache"});if(console.log("DataService.deleteQuery: Response status:",r.status),!r.ok){const l=await r.text();throw console.error("DataService.deleteQuery: Error response:",l),new Error(`HTTP error! status: ${r.status} - ${l}`)}}};H(ee,"instance",new ee);let W=ee;const te=class te{constructor(){H(this,"models",[]);H(this,"savedQueries",[]);H(this,"schemaMap",{});H(this,"spatialColumns",[]);H(this,"uiState",{leftPanelWidth:312,rightPanelWidth:437,isChatCollapsed:!1,isResultsDetailsCollapsed:!0,queryEditorHeight:50,resultsDetailsWidth:300});H(this,"selectionState",{selectedTable:null,selectedSchema:null,selectedQuery:null,selectedRowIndex:null});H(this,"sqlGenerationState",{generatedSql:null,isGenerating:!1,lastPrompt:null});H(this,"executionState",{isExecuting:!1,activeTabId:null,executionHistory:[]});H(this,"notifications",[]);H(this,"chartState",{tabConfigs:{},defaultChartType:"bar",showLegend:!0,showDataLabels:!1,colorPalette:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d3","#c7c7c7","#dbdb8d","#9edae5"]});H(this,"modelsChangedListeners",[]);H(this,"savedQueriesChangedListeners",[]);H(this,"uiStateChangedListeners",[]);H(this,"selectionStateChangedListeners",[]);H(this,"sqlGenerationStateChangedListeners",[]);H(this,"executionStateChangedListeners",[]);H(this,"notificationsChangedListeners",[]);H(this,"chartStateChangedListeners",[]);this.loadUIStateFromStorage(),this.loadChartStateFromStorage()}getModels(){return this.models}setModels(t){this.models=t,this.organizeModelsBySchema(),this.extractSpatialColumns(),this.modelsChangedListeners.forEach(n=>n())}getSavedQueries(){return this.savedQueries}setSavedQueries(t){this.savedQueries=t,this.savedQueriesChangedListeners.forEach(n=>n()),console.log("Saved queries set",this.savedQueries)}getSpatialColumns(){return this.spatialColumns}setSpatialColumns(t){this.spatialColumns=t}getSchemaMap(){return this.schemaMap}addModelsChangedListener(t){this.modelsChangedListeners.push(t)}removeModelsChangedListener(t){this.modelsChangedListeners=this.modelsChangedListeners.filter(n=>n!==t)}addSavedQueriesChangedListener(t){this.savedQueriesChangedListeners.push(t)}removeSavedQueriesChangedListener(t){this.savedQueriesChangedListeners=this.savedQueriesChangedListeners.filter(n=>n!==t)}extractSpatialColumns(){this.spatialColumns=[],this.models.forEach(t=>{t.columns&&Array.isArray(t.columns)&&t.columns.forEach(n=>{n.spatial_type&&n.spatial_type!==null&&n.spatial_type!==""&&this.spatialColumns.push(n.name)})})}organizeModelsBySchema(){return this.models.forEach(t=>{this.schemaMap[t.schema_name]||(this.schemaMap[t.schema_name]={}),this.schemaMap[t.schema_name][t.name]||(this.schemaMap[t.schema_name][t.name]=[]),t.columns&&(this.schemaMap[t.schema_name][t.name]=t.columns)}),console.log("Schema map",this.schemaMap),this.schemaMap}getUIState(){return{...this.uiState}}setUIState(t){this.uiState={...this.uiState,...t},this.saveUIStateToStorage(),this.uiStateChangedListeners.forEach(n=>n())}addUIStateChangedListener(t){this.uiStateChangedListeners.push(t)}removeUIStateChangedListener(t){this.uiStateChangedListeners=this.uiStateChangedListeners.filter(n=>n!==t)}loadUIStateFromStorage(){try{const t=localStorage.getItem("redfive_ui_state");if(t){const n=JSON.parse(t);this.uiState={...this.uiState,...n,isResultsDetailsCollapsed:!0}}}catch(t){console.warn("Failed to load UI state from storage:",t)}}saveUIStateToStorage(){try{localStorage.setItem("redfive_ui_state",JSON.stringify(this.uiState))}catch(t){console.warn("Failed to save UI state to storage:",t)}}getSelectionState(){return{...this.selectionState}}setSelectionState(t){this.selectionState={...this.selectionState,...t},this.selectionStateChangedListeners.forEach(n=>n())}addSelectionStateChangedListener(t){this.selectionStateChangedListeners.push(t)}removeSelectionStateChangedListener(t){this.selectionStateChangedListeners=this.selectionStateChangedListeners.filter(n=>n!==t)}getSqlGenerationState(){return{...this.sqlGenerationState}}setSqlGenerationState(t){this.sqlGenerationState={...this.sqlGenerationState,...t},this.sqlGenerationStateChangedListeners.forEach(n=>n())}addSqlGenerationStateChangedListener(t){this.sqlGenerationStateChangedListeners.push(t)}removeSqlGenerationStateChangedListener(t){this.sqlGenerationStateChangedListeners=this.sqlGenerationStateChangedListeners.filter(n=>n!==t)}getExecutionState(){return{...this.executionState}}setExecutionState(t){this.executionState={...this.executionState,...t},this.executionStateChangedListeners.forEach(n=>n())}addExecutionStateChangedListener(t){this.executionStateChangedListeners.push(t)}removeExecutionStateChangedListener(t){this.executionStateChangedListeners=this.executionStateChangedListeners.filter(n=>n!==t)}addToExecutionHistory(t){const n={...t,timestamp:Date.now()};this.executionState.executionHistory.unshift(n),this.executionState.executionHistory.length>50&&(this.executionState.executionHistory=this.executionState.executionHistory.slice(0,50)),this.executionStateChangedListeners.forEach(a=>a())}getNotifications(){return[...this.notifications]}addNotification(t){const n={...t,id:crypto.randomUUID(),isVisible:!0,duration:t.duration||3e3};return this.notifications.push(n),this.notificationsChangedListeners.forEach(a=>a()),setTimeout(()=>{this.removeNotification(n.id)},n.duration),n.id}removeNotification(t){const n=this.notifications.findIndex(a=>a.id===t);n!==-1&&(this.notifications[n].isVisible=!1,setTimeout(()=>{this.notifications=this.notifications.filter(a=>a.id!==t),this.notificationsChangedListeners.forEach(a=>a())},300),this.notificationsChangedListeners.forEach(a=>a()))}clearAllNotifications(){this.notifications.forEach(t=>t.isVisible=!1),setTimeout(()=>{this.notifications=[],this.notificationsChangedListeners.forEach(t=>t())},300),this.notificationsChangedListeners.forEach(t=>t())}addNotificationsChangedListener(t){this.notificationsChangedListeners.push(t)}removeNotificationsChangedListener(t){this.notificationsChangedListeners=this.notificationsChangedListeners.filter(n=>n!==t)}showSuccess(t,n){return this.addNotification({message:t,type:"success",duration:n})}showError(t,n){return this.addNotification({message:t,type:"error",duration:n||5e3})}showInfo(t,n){return this.addNotification({message:t,type:"info",duration:n})}getChartState(){return{...this.chartState}}setChartState(t){this.chartState={...this.chartState,...t},this.saveChartStateToStorage(),this.chartStateChangedListeners.forEach(n=>n())}getTabChartConfig(t){return this.chartState.tabConfigs[t]||null}setTabChartConfig(t,n){this.chartState.tabConfigs={...this.chartState.tabConfigs,[t]:{...n}},this.saveChartStateToStorage(),this.chartStateChangedListeners.forEach(a=>a())}removeTabChartConfig(t){const{[t]:n,...a}=this.chartState.tabConfigs;this.chartState.tabConfigs=a,this.saveChartStateToStorage(),this.chartStateChangedListeners.forEach(r=>r())}getDefaultChartConfig(t){const n=t.filter(a=>!["id","guid","uuid"].some(r=>a.toLowerCase().includes(r)));return{chart_type:this.chartState.defaultChartType,x_key:t[0]||null,y_key:n[0]||t[1]||null,series_key:null,series:[],filteredData:[],selectedSeriesValues:[]}}addChartStateChangedListener(t){this.chartStateChangedListeners.push(t)}removeChartStateChangedListener(t){this.chartStateChangedListeners=this.chartStateChangedListeners.filter(n=>n!==t)}loadChartStateFromStorage(){try{const t=localStorage.getItem("redfive_chart_state");if(t){const n=JSON.parse(t);this.chartState={...this.chartState,...n}}}catch(t){console.warn("Failed to load chart state from storage:",t)}}saveChartStateToStorage(){try{localStorage.setItem("redfive_chart_state",JSON.stringify(this.chartState))}catch(t){console.warn("Failed to save chart state to storage:",t)}}setDefaultChartType(t){this.setChartState({defaultChartType:t})}updateChartPreferences(t){this.setChartState(t)}getColorPalette(){return[...this.chartState.colorPalette]}resetChartState(){this.chartState={tabConfigs:{},defaultChartType:"bar",showLegend:!0,showDataLabels:!1,colorPalette:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d3","#c7c7c7","#dbdb8d","#9edae5"]},this.saveChartStateToStorage(),this.chartStateChangedListeners.forEach(t=>t())}};H(te,"instance",new te);let v=te;const Ve=()=>{const[i,t]=o.useState(v.instance.getUIState());return o.useEffect(()=>{const a=()=>{t(v.instance.getUIState())};return v.instance.addUIStateChangedListener(a),()=>v.instance.removeUIStateChangedListener(a)},[]),[i,a=>{v.instance.setUIState(a)}]},We=()=>{const[i,t]=o.useState(v.instance.getSelectionState());return o.useEffect(()=>{const a=()=>{t(v.instance.getSelectionState())};return v.instance.addSelectionStateChangedListener(a),()=>v.instance.removeSelectionStateChangedListener(a)},[]),[i,a=>{v.instance.setSelectionState(a)}]},Be=()=>{const[i,t]=o.useState(v.instance.getSqlGenerationState());return o.useEffect(()=>{const a=()=>{t(v.instance.getSqlGenerationState())};return v.instance.addSqlGenerationStateChangedListener(a),()=>v.instance.removeSqlGenerationStateChangedListener(a)},[]),[i,a=>{v.instance.setSqlGenerationState(a)}]},Je=()=>{const[i,t]=o.useState(v.instance.getExecutionState());return o.useEffect(()=>{const r=()=>{t(v.instance.getExecutionState())};return v.instance.addExecutionStateChangedListener(r),()=>v.instance.removeExecutionStateChangedListener(r)},[]),[i,r=>{v.instance.setExecutionState(r)},r=>{v.instance.addToExecutionHistory(r)}]},ye=()=>{const[i,t]=o.useState(v.instance.getChartState());return o.useEffect(()=>{const g=()=>{t(v.instance.getChartState())};return v.instance.addChartStateChangedListener(g),()=>v.instance.removeChartStateChangedListener(g)},[]),{chartState:i,updateChartState:g=>{v.instance.setChartState(g)},getTabChartConfig:g=>v.instance.getTabChartConfig(g),setTabChartConfig:(g,S)=>{v.instance.setTabChartConfig(g,S)},removeTabChartConfig:g=>{v.instance.removeTabChartConfig(g)},getDefaultChartConfig:g=>v.instance.getDefaultChartConfig(g),setDefaultChartType:g=>{v.instance.setDefaultChartType(g)},updateChartPreferences:g=>{v.instance.updateChartPreferences(g)},getColorPalette:()=>v.instance.getColorPalette()}},se=()=>{const[i,t]=Ve(),[n,a]=We(),[r,l]=Be(),[h,b,c]=Je(),u=ye();return{uiState:i,updateUIState:t,selectionState:n,updateSelectionState:a,sqlGenerationState:r,updateSqlGenerationState:l,executionState:h,updateExecutionState:b,addToExecutionHistory:c,showSuccess:(j,C)=>v.instance.showSuccess(j,C),showError:(j,C)=>v.instance.showError(j,C),showInfo:(j,C)=>v.instance.showInfo(j,C),...u}},Ye=({isOpen:i,onClose:t,onConfirm:n,title:a,message:r,confirmText:l="Confirm",cancelText:h="Cancel",isProcessing:b=!1,variant:c="danger"})=>{if(!i)return null;const u=()=>{b||n()},g=()=>{b||t()},T=(()=>{switch(c){case"danger":return{icon:"bi-exclamation-triangle-fill text-danger",confirmBtn:"btn-danger"};case"warning":return{icon:"bi-exclamation-triangle-fill text-warning",confirmBtn:"btn-warning"};case"primary":return{icon:"bi-question-circle-fill text-primary",confirmBtn:"btn-primary"};default:return{icon:"bi-exclamation-triangle-fill text-danger",confirmBtn:"btn-danger"}}})();return e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title d-flex align-items-center",children:[e.jsx("i",{className:`bi ${T.icon} me-2`}),a]}),e.jsx("button",{type:"button",className:"btn-close",onClick:g,disabled:b})]}),e.jsx("div",{className:"modal-body",children:e.jsx("p",{className:"mb-0",children:r})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:g,disabled:b,children:h}),e.jsx("button",{type:"button",className:`btn ${T.confirmBtn}`,onClick:u,disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Processing..."]}):l})]})]})})})},Xe=({className:i=""})=>{const{updateSelectionState:t,showError:n,showSuccess:a}=se(),[r,l]=o.useState({databases:!0,production:!0,schemas:!0,"saved-queries":!1}),[h,b]=o.useState([]),[c,u]=o.useState(!1),[g,S]=o.useState([]),[T,j]=o.useState(!1),[C,$]=o.useState({show:!1,x:0,y:0,type:"table",item:null}),[I,w]=o.useState({isOpen:!1,query:null,isDeleting:!1});o.useEffect(()=>{const s=()=>{b(v.instance.getModels())},d=()=>{const x=v.instance.getSavedQueries();S(x)};return v.instance.addModelsChangedListener(s),v.instance.addSavedQueriesChangedListener(d),()=>{v.instance.removeModelsChangedListener(s),v.instance.removeSavedQueriesChangedListener(d)}},[]);const _=s=>{l(d=>({...d,[s]:!d[s]}))},P=o.useMemo(()=>v.instance.getSchemaMap(),[h]),K=async()=>{u(!0);try{const s=await W.instance.listModels();v.instance.setModels(s);const d={databases:!0,production:!0,schemas:!0,"saved-queries":!1};Object.keys(P).forEach(x=>{d[`schema-${x}`]=!0}),l(d)}catch(s){console.error("Error loading models",s),n("Failed to load models"),b([])}finally{u(!1)}},D=async()=>{j(!0);try{const s=await W.instance.listQueries();v.instance.setSavedQueries(s)}catch(s){console.error("Error loading saved queries",s),n("Failed to load saved queries"),v.instance.setSavedQueries([])}finally{j(!1)}};o.useEffect(()=>{K(),D()},[]);const N=(s,d,x)=>{s.preventDefault(),s.stopPropagation(),$({show:!0,x:s.clientX,y:s.clientY,type:d,item:x})},m=()=>{$({show:!1,x:0,y:0,type:"table",item:null})};return o.useEffect(()=>{const s=()=>{C.show&&m()};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[C.show]),e.jsxs("div",{className:`bg-light border-end d-flex flex-column h-100 ${i}`,style:{overflow:"hidden"},children:[e.jsx("div",{className:"p-2 border-bottom panel-header",style:{background:"linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"text-muted mb-0 d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-folder me-2"}),"Model Explorer"]}),e.jsx("div",{className:"d-flex gap-1",children:e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>{K(),D()},disabled:c||T,title:"Reload models and queries",children:c||T?e.jsx("i",{className:"bi bi-hourglass-split"}):e.jsx("i",{className:"bi bi-arrow-clockwise"})})})]})}),e.jsx("div",{className:"flex-grow-1",style:{height:"0",minHeight:"0",overflowY:"auto",overflowX:"hidden"},onContextMenu:s=>{s.preventDefault(),s.stopPropagation()},children:c?e.jsxs("div",{className:"p-3 text-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-muted",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"small text-muted mt-2",children:"Loading models..."})]}):h.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{_("schemas"),t({selectedSchema:"default",selectedTable:null})},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${r.schemas?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:"Schemas"})]}),r.schemas&&e.jsx("div",{className:"explorer-children",children:Object.entries(P).sort(([s],[d])=>s.localeCompare(d)).map(([s,d])=>e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{_(`schema-${s}`),t({selectedSchema:s,selectedTable:null})},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${r[`schema-${s}`]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:s})]}),r[`schema-${s}`]&&e.jsx("div",{className:"explorer-children",children:Object.entries(d).sort(([x],[k])=>x.localeCompare(k)).map(([x,k])=>{const R=Array.isArray(h)?h.find(E=>E.name===x):null;return e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>{_(`table-${s}-${x}`),R&&t({selectedTable:R})},onContextMenu:E=>{E.preventDefault(),E.stopPropagation(),N(E,"table",R||{name:x,schema:s})},style:{cursor:"pointer"},children:[e.jsx("i",{className:`bi ${r[`table-${s}-${x}`]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-table me-2"}),e.jsx("span",{children:x})]}),r[`table-${s}-${x}`]&&e.jsx("div",{className:"explorer-children",children:k.map(E=>e.jsxs("div",{className:"explorer-file",onClick:()=>{console.log("Column selected:",E.name)},onContextMenu:L=>{L.preventDefault(),L.stopPropagation(),N(L,"column",E)},style:{cursor:"pointer"},children:[e.jsx("i",{className:"bi bi-columns me-2"}),e.jsxs("span",{children:[E.name,E.spatial_type==="point"?e.jsx("span",{style:{color:"#aa0000"},children:"*"}):E.spatial_type==="polyline"?e.jsx("span",{style:{color:"#aa0000"},children:"**"}):E.spatial_type==="polygon"?e.jsx("span",{style:{color:"#aa0000"},children:"***"}):""]}),e.jsxs("span",{className:"text-muted small ms-2",children:["(",E.type,")"]})]},E.name))})]},x)})})]},s))})]}),e.jsxs("div",{className:"explorer-item",children:[e.jsxs("div",{className:"explorer-folder",onClick:()=>_("saved-queries"),children:[e.jsx("i",{className:`bi ${r["saved-queries"]?"bi-chevron-down":"bi-chevron-right"} me-1`}),e.jsx("i",{className:"bi bi-folder me-2"}),e.jsx("span",{children:"Saved Queries"})]}),r["saved-queries"]&&e.jsx("div",{className:"explorer-children",children:T?e.jsxs("div",{className:"p-2 text-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-muted",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"small text-muted mt-1",children:"Loading queries..."})]}):g.length>0?g.map(s=>e.jsxs("div",{className:"explorer-file",onClick:()=>{t({selectedQuery:s})},onContextMenu:d=>{d.preventDefault(),d.stopPropagation(),N(d,"query",s)},style:{cursor:"pointer"},children:[e.jsx("i",{className:"bi bi-file-text me-2"}),e.jsx("span",{children:s.name}),s.isPublic&&e.jsx("i",{className:"bi bi-globe ms-2 text-info",title:"Public query"})]},s.guid)):e.jsxs("div",{className:"p-2 text-center text-muted",children:[e.jsx("i",{className:"bi bi-file-text fs-4 mb-1"}),e.jsx("div",{className:"small",children:"No saved queries"})]})})]})]}):e.jsxs("div",{className:"p-3 text-center text-muted",children:[e.jsx("i",{className:"bi bi-database fs-1 mb-2"}),e.jsx("div",{children:"No models loaded"}),e.jsx("small",{children:"Models will appear here once loaded"})]})}),C.show&&e.jsxs("div",{className:"context-menu",style:{position:"fixed",top:C.y,left:C.x,zIndex:9999,backgroundColor:"white",border:"1px solid #ccc",borderRadius:"4px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",padding:"4px 0",minWidth:"180px",fontSize:"14px"},onClick:s=>s.stopPropagation(),children:[C.type==="table"&&e.jsxs("div",{className:"context-menu-item",onClick:()=>{console.log("Generate select for table:",C.item),$({show:!1,x:0,y:0,type:"table",item:null})},style:{padding:"10px 16px",cursor:"pointer",fontSize:"14px",display:"flex",alignItems:"center",gap:"10px",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s"},onMouseEnter:s=>{s.currentTarget.style.backgroundColor="#f8f9fa"},onMouseLeave:s=>{s.currentTarget.style.backgroundColor="transparent"},children:[e.jsx("i",{className:"bi bi-code-slash text-success"}),e.jsx("span",{children:"Generate Select"})]}),C.type==="query"&&e.jsxs("div",{className:"context-menu-item",onClick:()=>{const s=C.item;w({isOpen:!0,query:s,isDeleting:!1}),$({show:!1,x:0,y:0,type:"table",item:null})},style:{padding:"10px 16px",cursor:"pointer",fontSize:"14px",display:"flex",alignItems:"center",gap:"10px",transition:"background-color 0.2s"},onMouseEnter:s=>{s.currentTarget.style.backgroundColor="#f8f9fa"},onMouseLeave:s=>{s.currentTarget.style.backgroundColor="transparent"},children:[e.jsx("i",{className:"bi bi-trash text-danger"}),e.jsx("span",{children:"Delete Query"})]})]}),e.jsx(Ye,{isOpen:I.isOpen,onClose:()=>w({isOpen:!1,query:null,isDeleting:!1}),onConfirm:async()=>{if(I.query){w(s=>({...s,isDeleting:!0}));try{await W.instance.deleteQuery(I.query.guid),a(`Query "${I.query.name}" deleted successfully`),D(),w({isOpen:!1,query:null,isDeleting:!1})}catch(s){console.error("Error deleting query:",s),n("Failed to delete query"),w(d=>({...d,isDeleting:!1}))}}},title:"Delete Query",message:I.query?`Are you sure you want to delete the query "${I.query.name}"? This action cannot be undone.`:"",confirmText:"Delete",cancelText:"Cancel",isProcessing:I.isDeleting,variant:"danger"})]})},Ze=o.memo(Xe),et=({results:i,columns:t,isExecuting:n,error:a,selectedRowIndex:r,onRowSelect:l})=>{const h=o.useRef(null);return o.useEffect(()=>{const b=u=>{if(i.length!==0){if(u.key==="ArrowDown"){u.preventDefault();const g=r===null?0:Math.min(r+1,i.length-1);l(g)}else if(u.key==="ArrowUp"){u.preventDefault();const g=r===null?0:Math.max(r-1,0);l(g)}}},c=h.current;if(c)return c.addEventListener("keydown",b),()=>c.removeEventListener("keydown",b)},[i.length,r,l]),o.useEffect(()=>{i.length>0&&r===null&&l(0)},[i.length,r,l]),e.jsxs("div",{ref:h,className:"p-2 flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},tabIndex:0,onFocus:()=>{h.current&&h.current.focus()},children:[n&&e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-danger",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-2 text-muted",children:"Executing query..."})]})}),a&&e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),e.jsx("strong",{children:"Query Error:"})," ",a]}),!n&&!a&&i.length>0&&e.jsx("div",{className:"flex-grow-1",style:{overflowY:"auto",overflowX:"auto",height:"100%",scrollbarWidth:"thin"},children:e.jsxs("table",{className:"table table-striped table-hover table-sm",style:{whiteSpace:"nowrap",fontSize:"0.875rem"},children:[e.jsx("thead",{className:"sticky-top",children:e.jsx("tr",{children:t.map((b,c)=>e.jsx("th",{style:{whiteSpace:"nowrap",padding:"0.5rem 0.6rem 0.4rem 0.6rem",lineHeight:"1.2",color:"white",backgroundColor:"#495057",border:"none"},children:b},c))})}),e.jsx("tbody",{children:i.map((b,c)=>e.jsx("tr",{className:r===c?"table-row-selected":"",style:{lineHeight:"1.2",cursor:"pointer",transition:"background-color 0.2s ease",backgroundColor:r===c?"#e3f2fd":"transparent"},onClick:()=>l(c),onMouseEnter:u=>{r!==c&&(u.currentTarget.style.backgroundColor="#f5f5f5")},onMouseLeave:u=>{r!==c&&(u.currentTarget.style.backgroundColor="transparent")},children:t.map((u,g)=>e.jsx("td",{style:{whiteSpace:"nowrap",padding:"0.4rem 0.6rem",lineHeight:"1.2"},children:b[u]!==null&&b[u]!==void 0?String(b[u]):e.jsx("span",{className:"text-muted",children:"NULL"})},g))},c))})]})}),!n&&!a&&i.length===0&&e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-table display-4 mb-3"}),e.jsx("div",{children:"No results to display"}),e.jsx("small",{children:"Execute a query to see results here"})]})})]})},tt=o.memo(et),st={chart_type:{description:"line, bar, area, scatter, pie"}},nt={properties:st},at=({queryResults:i,columns:t,onConfigChange:n,initialConfig:a,className:r=""})=>{const[l,h]=o.useState(()=>a?{chart_type:a.chart_type||"bar",x_key:a.x_key||null,y_key:a.y_key||null,series_key:a.series_key||null,showMarkers:a.showMarkers!==void 0?a.showMarkers:!0,series:a.series||[]}:{chart_type:"bar",x_key:null,y_key:null,series_key:null,showMarkers:!0,series:[]}),[b,c]=o.useState(()=>a?.selectedSeriesValues||[]),u=o.useRef(null),g=(s,d,x)=>({chart_type:s.chart_type,x_key:s.x_key,y_key:s.y_key,series_key:s.series_key,showMarkers:s.showMarkers,series:s.series,filteredData:d,selectedSeriesValues:x});o.useEffect(()=>{a?(h({chart_type:a.chart_type||"bar",x_key:a.x_key||null,y_key:a.y_key||null,series_key:a.series_key||null,showMarkers:a.showMarkers!==void 0?a.showMarkers:!0,series:a.series||[]}),c(a.selectedSeriesValues||[])):(h({chart_type:"bar",x_key:null,y_key:null,series_key:null,showMarkers:!0,series:[]}),c([]))},[a]);const S=o.useMemo(()=>nt.properties.chart_type.description?.split(", ")||["line","bar","area","scatter","pie"],[]),T=o.useMemo(()=>!l.series_key||!i||i.length===0?[]:[...new Set(i.map(d=>l.series_key?d[l.series_key]:null).filter(d=>d!=null))].sort(),[l.series_key,i]),j=o.useMemo(()=>!l.series_key||b.length===0?i:i.filter(s=>l.series_key?b.includes(s[l.series_key]):!1),[i,l.series_key,b]);o.useEffect(()=>{if(l.x_key&&l.y_key&&l.series_key&&i&&i.length>0){const d=[...new Set(i.map(x=>l.series_key?x[l.series_key]:null).filter(x=>x!=null))].map(x=>({type:l.chart_type,xKey:l.x_key,yKey:l.y_key,seriesValue:x}));h(x=>({...x,series:d}))}else h(s=>({...s,series:[]}))},[l.x_key,l.y_key,l.series_key,l.chart_type,i]),o.useEffect(()=>{if(l.x_key&&l.y_key){const s=g(l,j,b);(!u.current||u.current.chart_type!==s.chart_type||u.current.x_key!==s.x_key||u.current.y_key!==s.y_key||u.current.series_key!==s.series_key||u.current.showMarkers!==s.showMarkers||u.current.selectedSeriesValues?.length!==s.selectedSeriesValues?.length||u.current.selectedSeriesValues&&s.selectedSeriesValues&&!u.current.selectedSeriesValues.every((x,k)=>x===s.selectedSeriesValues[k])||u.current.filteredData?.length!==s.filteredData?.length)&&(u.current=s,n(s))}},[l.x_key,l.y_key,l.series_key,l.chart_type,l.showMarkers,l.series,j,b,n]);const C=s=>{h(d=>({...d,chart_type:s,series:d.series.map(x=>({...x,type:s}))}))},$=s=>{h(d=>({...d,x_key:s||null}))},I=s=>{h(d=>({...d,y_key:s||null}))},w=s=>{h(d=>({...d,series_key:s||null})),c([])},_=s=>{c(d=>d.includes(s)?d.filter(k=>k!==s):[...d,s])},P=()=>{c(T)},K=()=>{c([])},D=s=>{h(d=>({...d,showMarkers:s}))},N=o.useMemo(()=>!i||i.length===0?t:t.filter(s=>{const d=Math.min(5,i.length),k=i.slice(0,d).map(E=>E[s]).filter(E=>E!=null);return k.length===0?!1:k.filter(E=>typeof E=="number"&&!isNaN(E)||typeof E=="string"&&!isNaN(Number(E))&&E.trim()!=="").length/k.length>=.8}),[t,i]),m=o.useMemo(()=>!i||i.length===0?t:t.filter(s=>{const d=Math.min(5,i.length),k=i.slice(0,d).map(L=>L[s]).filter(L=>L!=null);if(k.length===0)return!0;const R=k.map(L=>typeof L);return[...new Set(R)].some(L=>L==="string"||L==="number"||L==="boolean"||L==="object")}),[t,i]);return!i||i.length===0?e.jsxs("div",{className:`p-3 text-center text-muted ${r}`,children:[e.jsx("i",{className:"bi bi-bar-chart display-4 mb-3"}),e.jsx("div",{children:"No Data Available"}),e.jsx("small",{children:"Execute a query to configure charts"})]}):e.jsxs("div",{className:`px-3 py-2 ${r}`,style:{fontSize:"0.85rem"},children:[e.jsx("div",{className:"mb-2",children:e.jsx("h6",{className:"text-muted mb-2",style:{fontSize:"0.9rem"}})}),e.jsxs("div",{className:"row g-2",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Chart Type"}),e.jsx("select",{className:"form-select",value:l.chart_type,onChange:s=>C(s.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:S.map(s=>e.jsx("option",{value:s,children:s.charAt(0).toUpperCase()+s.slice(1)},s))})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:" "}),e.jsxs("div",{className:"form-check d-flex align-items-center justify-content-center",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"showMarkers",checked:l.showMarkers,onChange:s=>D(s.target.checked),style:{accentColor:"#aa0000",transform:"scale(1.1)"}}),e.jsx("label",{className:"form-check-label",htmlFor:"showMarkers",style:{fontSize:"0.8rem",marginLeft:"0.5rem"},children:"Markers"})]})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"X-Axis (Category)"}),e.jsxs("select",{className:"form-select",value:l.x_key||"",onChange:s=>$(s.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select X-axis column"}),m.map(s=>{const d=i?.[0]?.[s];let x="";if(d!=null){const k=typeof d;k==="string"?x=" (text)":k==="number"?x=" (numeric)":k==="boolean"?x=" (true/false)":d instanceof Date?x=" (date)":k==="object"&&(x=" (object)")}return e.jsxs("option",{value:s,children:[s,x]},s)})]}),m.length===0&&e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"No suitable columns found for X-axis"}),e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"Categories, dates, or grouping columns"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Y-Axis (Values)"}),e.jsxs("select",{className:"form-select",value:l.y_key||"",onChange:s=>I(s.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select Y-axis column"}),N.map(s=>{const d=i?.[0]?.[s];let x="";return d!=null&&(typeof d==="number"?x=" (number)":typeof d=="string"&&!isNaN(Number(d))&&(x=" (numeric text)")),e.jsxs("option",{value:s,children:[s,x]},s)})]}),N.length===0&&e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"No numeric columns found for Y-axis"}),e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"Numeric values for measurements or counts"})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("label",{className:"form-label fw-bold",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Series Differentiation"}),e.jsxs("select",{className:"form-select",value:l.series_key||"",onChange:s=>w(s.target.value),style:{borderColor:"#aa0000",fontSize:"0.8rem"},children:[e.jsx("option",{value:"",children:"Select series column"}),m.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsx("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"},children:"Column that groups data into different series"})]}),l.series_key&&T.length>0&&e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"border-top pt-3 mt-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("label",{className:"form-label fw-bold mb-0",style:{color:"#aa0000",fontSize:"0.8rem"},children:"Filter Series"}),e.jsxs("div",{className:"btn-group btn-group-sm",role:"group",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:P,children:"Select All"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:K,children:"Deselect All"})]})]}),b.length===0&&e.jsxs("div",{className:"alert alert-warning py-2 px-3 mb-2",style:{fontSize:"0.75rem"},children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),'No series selected. Click "Select All" to show all data series in the chart.']}),e.jsx("div",{className:"d-flex flex-column gap-2",children:T.map((s,d)=>e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:`series-${d}`,checked:b.includes(s),onChange:()=>_(s),style:{accentColor:"#aa0000"}}),e.jsx("label",{className:"form-check-label",htmlFor:`series-${d}`,children:String(s)})]},s))}),e.jsxs("div",{className:"text-muted small mt-2",style:{fontSize:"0.75rem"},children:["Showing ",b.length===0?T.length:b.length," of ",T.length," series"]})]})})]})]})},rt=({metadata:i,queryResults:t=[],columns:n=[],chartConfig:a,onChartConfigChange:r,tabId:l})=>{const{chartState:h,getColorPalette:b}=ye(),[c,u]=o.useState(!1),[g,S]=o.useState(!1),[T,j]=o.useState(500),C=o.useRef(null),$=o.useRef(null);o.useEffect(()=>{const w=()=>{if(C.current){const K=C.current.clientHeight;K>0&&K!==T&&($.current&&cancelAnimationFrame($.current),$.current=requestAnimationFrame(()=>{j(K),$.current=null}))}},_=setTimeout(w,100),P=new ResizeObserver(w);return C.current&&P.observe(C.current),()=>{clearTimeout(_),P.disconnect(),$.current&&cancelAnimationFrame($.current)}},[T]);const I=o.useMemo(()=>{if(!a||!t||t.length===0)return null;const{chart_type:w,x_key:_,y_key:P,series_key:K,showMarkers:D,filteredData:N,selectedSeriesValues:m}=a,s=N&&N.length>0?N:t,d=b();let x=[],k=[];if(K&&P&&_){const E=[...new Set((s||[]).map(q=>q[_]))].sort(),L=[...new Set((s||[]).map(q=>q[K]).filter(q=>q!=null).filter(q=>!m||m.length===0||m.includes(q)))].sort(),O={};(s||[]).forEach(q=>{const M=q[_],z=q[K],ne=q[P];if(M!=null&&z!==null&&z!==void 0&&(!m||m.length===0||m.includes(z))){const J=`${M}`;O[J]||(O[J]={[_]:M}),O[J][`series_${z}`]=ne}}),x=E.map(q=>{const M=`${q}`;return O[M]||{[_]:q}}),k=L.map((q,M)=>({type:w,xKey:_,yKey:`series_${q}`,yName:q,connectMissingData:!1,style:{fill:d[M%d.length],stroke:d[M%d.length]},marker:{enabled:D!==void 0?D:w==="scatter"||w==="line",size:w==="scatter"?6:4}}))}else x=s||[],k=[{type:w,xKey:_,yKey:P,connectMissingData:!1,style:{fill:d[0],stroke:d[0]},marker:{enabled:D!==void 0?D:w==="scatter"||w==="line",size:w==="scatter"?6:4}}];return{data:x,series:k,title:{text:P&&_?`${P.toUpperCase()} by ${_.toUpperCase()}`:"Query Results Visualization",fontSize:16,color:"#aa0000"},background:{fill:"transparent"},axes:[{type:"category",position:"bottom",title:{text:_||"X-Axis",fontSize:12},label:{rotation:k.length>1?45:0,fontSize:11}},{type:"number",position:"left",title:{text:P||"Y-Axis",fontSize:12},label:{fontSize:11}}],legend:{enabled:h.showLegend&&k.length>1,position:"bottom",item:{marker:{shape:w==="line"?"line":"square",size:12},label:{fontSize:11}},spacing:20},padding:{top:20,right:20,bottom:k.length>1?60:40,left:50},width:"100%",height:T}},[a,t,h.showLegend,b,T]);return e.jsx("div",{ref:C,className:"flex-grow-1 d-flex position-relative",style:{height:"100%",overflow:"hidden"},children:t&&t.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",style:{overflow:"hidden",minHeight:0},children:[I?e.jsx("div",{className:"flex-grow-1",style:{width:"100%",height:"100%"},children:e.jsx(qe,{options:I})}):e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-bar-chart display-4 mb-3"}),e.jsx("div",{children:"Configure Chart"}),e.jsx("small",{children:"Use the configuration panel to set up your visualization"})]})}),i&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>S(!g),style:{fontSize:"0.8rem"},children:[e.jsx("i",{className:`bi ${g?"bi-chevron-down":"bi-chevron-right"} me-1`}),"Raw Metadata"]}),g&&e.jsx("div",{className:"mt-2",style:{maxHeight:"200px",overflow:"auto"},children:e.jsx("pre",{className:"bg-light p-3 rounded",style:{fontSize:"0.75rem",lineHeight:"1.4",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(i,null,2)})})]}),!c&&e.jsx("div",{className:"position-absolute",style:{top:"10px",right:"10px",zIndex:1e3},children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"white",borderColor:"#aa0000",color:"#aa0000",fontSize:"0.75rem",padding:"0.25rem 0.5rem"},onClick:()=>u(!0),title:"Open configuration panel",children:"Show Config"})})]}),e.jsxs("div",{className:`border-start bg-light d-flex flex-column ${c?"":"d-none"}`,style:{width:"350px",minWidth:"350px"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center px-3 py-2 border-bottom",children:[e.jsx("h6",{className:"mb-0 text-muted",style:{fontSize:"0.9rem"},children:"Chart Configuration"}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"white",borderColor:"#aa0000",color:"#aa0000",fontSize:"0.75rem"},onClick:()=>u(!c),title:c?"Collapse configuration":"Expand configuration",children:"Hide Config"})]}),e.jsx("div",{className:"flex-grow-1",style:{overflow:"auto"},children:e.jsx(at,{queryResults:t,columns:n,onConfigChange:r,initialConfig:a},l)})]})]}):e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-graph-up display-4 mb-3"}),e.jsx("div",{children:"No Analysis Available"}),e.jsx("small",{children:"Execute a query to see execution metadata and configure charts"})]})})})},it=o.memo(rt),ot=({results:i,columns:t,onRowSelect:n,selectedRowIndex:a})=>{const r=o.useRef(null),l=o.useRef(null),[h,b]=o.useState(!1),[c,u]=o.useState(null),[g,S]=o.useState(null),T=o.useRef("");o.useEffect(()=>r.current?((async()=>{try{const m=document.createElement("link");m.rel="stylesheet",m.href="https://js.arcgis.com/4.29/esri/themes/light/main.css",document.head.appendChild(m);const s=new ze({basemap:"gray-vector"}),d=new Fe({container:r.current,map:s,center:[-98.5795,39.8283],zoom:4});l.current=d,await d.when(),b(!0),d.on("click",k=>{d.hitTest(k).then(R=>{if(R.results.length>0){const E=R.results[0].graphic;if(E&&E.attributes&&E.attributes.id!==void 0){const L=E.attributes.id;S(L),n&&n(L)}}})});const x=new Ue;s.add(x),i&&i.length>0&&$(i,t,x,!0)}catch{u("Failed to initialize map")}})(),()=>{l.current&&(l.current.destroy(),l.current=null)}):void 0,[]);const j=(N,m)=>{const s=JSON.stringify({results:N,columns:m});return btoa(s).slice(0,16)};o.useEffect(()=>{if(h&&i&&i.length>0&&l.current){const N=l.current.map.layers.find(m=>m.type==="graphics");if(N){const m=j(i,t||[]),s=m!==T.current;N.removeAll(),$(i,t||[],N,s),s&&(T.current=m)}}},[i,t,h]),o.useEffect(()=>{if(h&&l.current){const N=l.current.map.layers.find(m=>m.type==="graphics");N&&C(N,g)}},[g,h]),o.useEffect(()=>{const N=s=>{if(!(!i||i.length===0||!n)){if(s.key==="ArrowDown"){s.preventDefault();const x=Math.min((a??-1)+1,i.length-1);n(x)}else if(s.key==="ArrowUp"){s.preventDefault();const x=Math.max((a??0)-1,0);n(x)}}},m=r.current;if(m)return m.addEventListener("keydown",N),()=>m.removeEventListener("keydown",N)},[i,a,n]),o.useEffect(()=>{a!=null&&a!==g&&S(a)},[a,g]);const C=(N,m)=>{N&&N.graphics.forEach(s=>{const d=s.attributes.id===m;s.geometry.type==="point"?s.symbol=new le({color:d?"white":"#aa0000",size:d?12:8,outline:d?{color:"#aa0000",width:2}:{color:"#aa0000",width:2},style:"circle"}):s.geometry.type==="polyline"?s.symbol=new ce({color:d?"#ff0000":"#aa0000",width:d?5:3}):s.geometry.type==="polygon"&&(s.symbol=new de({color:d?[255,0,0,.5]:[170,0,0,.3],outline:{color:d?"#ff0000":"#aa0000",width:d?3:2}}))})},$=(N,m=[],s,d=!0)=>{if(!N||N.length===0)return;const x=m.filter(k=>N.some(R=>R[k]&&typeof R[k]=="string"&&(R[k].includes("POINT")||R[k].includes("LINESTRING")||R[k].includes("POLYGON")||R[k].startsWith("point:")||R[k].startsWith("linestring:")||R[k].startsWith("polygon:"))));x.length!==0&&(N.forEach((k,R)=>{x.forEach(E=>{const L=k[E];if(L)try{let O,q;if(L.startsWith("point:")){const M=w(L);M&&(O=new fe({longitude:M.longitude,latitude:M.latitude,spatialReference:{wkid:M.crs}}),q=new le({color:"white",size:8,outline:{color:"#aa0000",width:2},style:"circle"}))}else if(L.startsWith("linestring:")){const M=_(L);M&&(O=new xe({paths:[M.coordinates],spatialReference:{wkid:M.crs}}),q=new ce({color:"#aa0000",width:3}))}else if(L.startsWith("polygon:")){const M=P(L);M&&(O=new ge({rings:M.rings,spatialReference:{wkid:M.crs}}),q=new de({color:[170,0,0,.3],outline:{color:"#aa0000",width:2}}))}else if(L.includes("POINT")){const M=I(L);M&&(O=new fe({longitude:M[0],latitude:M[1],spatialReference:{wkid:4326}}),q=new le({color:"white",size:8,outline:{color:"#aa0000",width:2},style:"circle"}))}else if(L.includes("LINESTRING")){const M=K(L);M&&(O=new xe({paths:[M],spatialReference:{wkid:4326}}),q=new ce({color:"#aa0000",width:3}))}else if(L.includes("POLYGON")){const M=D(L);M&&(O=new ge({rings:M,spatialReference:{wkid:4326}}),q=new de({color:[170,0,0,.3],outline:{color:"#aa0000",width:2}}))}if(O&&q){const M=new Re({geometry:O,symbol:q,attributes:{id:R,...k}});s.add(M)}}catch{}})}),d&&s.graphics.length>0&&l.current?.goTo(s.graphics))},I=N=>{const m=N.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);return m?[parseFloat(m[1]),parseFloat(m[2])]:null},w=N=>{const m=N.match(/^point:\s*([-\d.]+),\s*([-\d.]+),\s*(\d+)$/i);return m?{longitude:parseFloat(m[1]),latitude:parseFloat(m[2]),crs:parseInt(m[3])}:null},_=N=>{const m=N.match(/^linestring:\s*([^,]+(?:,[^,]+)*),\s*(\d+)$/i);if(m){const s=m[1].split(",");if(s.length>=4&&s.length%2===0){const d=[];for(let x=0;x<s.length;x+=2)d.push([parseFloat(s[x]),parseFloat(s[x+1])]);return{coordinates:d,crs:parseInt(m[2])}}}return null},P=N=>{const m=N.match(/^polygon:\s*\(([^)]+)\),\s*(\d+)$/i);if(m){const s=m[1].split(",");if(s.length>=6&&s.length%2===0){const d=[];for(let x=0;x<s.length;x+=2)d.push([parseFloat(s[x]),parseFloat(s[x+1])]);return{rings:[d],crs:parseInt(m[2])}}}return null},K=N=>{const m=N.match(/LINESTRING\s*\((.*?)\)/i);return m?m[1].split(",").map(d=>{const[x,k]=d.trim().split(/\s+/);return[parseFloat(x),parseFloat(k)]}):null},D=N=>{const m=N.match(/POLYGON\s*\((.*?)\)/i);return m?m[1].split("),(").map(d=>d.replace(/[()]/g,"").split(",").map(k=>{const[R,E]=k.trim().split(/\s+/);return[parseFloat(R),parseFloat(E)]})):null};return e.jsx("div",{className:"flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},children:c?e.jsx("div",{className:"d-flex justify-content-center align-items-center flex-grow-1",children:e.jsxs("div",{className:"text-center text-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle display-4 mb-3"}),e.jsx("div",{children:"Map Error"}),e.jsx("small",{children:c})]})}):e.jsx("div",{ref:r,className:"flex-grow-1",style:{height:"100%",width:"100%"},tabIndex:0,onFocus:()=>{r.current&&r.current.focus()}})})},lt=o.memo(ot),ct=({results:i,columns:t,rowCount:n,isExecuting:a,error:r,selectedRowIndex:l,onRowSelect:h,metadata:b,spatialColumns:c=[],chartConfig:u,onChartConfigChange:g,tabId:S,className:T=""})=>{const[j,C]=o.useState("table"),$=c.some(I=>t.includes(I));return o.useEffect(()=>{j==="map"&&!$&&C("table")},[j,$]),e.jsxs("div",{className:`flex-grow-1 d-flex flex-column results-panel ${T}`,style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom",style:{flexShrink:0,paddingTop:"calc(0.5rem - 3px)",borderBottomWidth:"1px"},children:e.jsxs("div",{className:"d-flex",children:[e.jsx("div",{className:`tab-item ${j==="table"?"active":""}`,onClick:()=>C("table"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-table me-1"}),"Results",n>0&&e.jsxs("span",{className:"ms-1",children:["(",n,")"]})]})}),e.jsx("div",{className:`tab-item ${j==="analysis"?"active":""}`,onClick:()=>C("analysis"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-graph-up me-1"}),"Chart"]})}),$&&e.jsx("div",{className:`tab-item ${j==="map"?"active":""}`,onClick:()=>C("map"),children:e.jsxs("span",{className:"tab-name",children:[e.jsx("i",{className:"bi bi-geo-alt me-1"}),"Map"]})})]})}),e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{style:{display:j==="table"?"flex":"none",height:"100%",flexDirection:"column"},children:e.jsx(tt,{results:i,columns:t,rowCount:n,isExecuting:a,error:r,selectedRowIndex:l,onRowSelect:h})}),e.jsx("div",{style:{display:j==="analysis"?"flex":"none",height:"100%",flexDirection:"column",overflow:"hidden"},children:e.jsx(it,{metadata:b,queryResults:i,columns:t,chartConfig:u,onChartConfigChange:g||(()=>{}),tabId:S})}),$&&e.jsx("div",{style:{display:j==="map"?"flex":"none",height:"100%",flexDirection:"column"},children:e.jsx(lt,{results:i,columns:t,onRowSelect:h,selectedRowIndex:l})})]})]})},dt=o.memo(ct),ut=({results:i,columns:t,isExecuting:n,error:a,selectedRow:r,isCollapsed:l,onToggle:h,className:b=""})=>l?e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${b}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 d-flex justify-content-center",children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:h,title:"Expand results details",children:e.jsx("i",{className:"bi bi-chevron-left"})})}),e.jsx("div",{className:"flex-grow-1 d-flex justify-content-center align-items-center",children:e.jsx("div",{style:{writingMode:"vertical-rl",textOrientation:"mixed",transform:"rotate(360deg)",fontSize:"1rem",fontWeight:"500",color:"#aa0000"},children:"Details"})})]}):e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${b}`,style:{height:"100%",overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom flex-shrink-0",style:{padding:"calc(0.3125rem + 3px) 0.5rem"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Details"]}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:h,title:"Collapse details panel",children:e.jsx("i",{className:"bi bi-chevron-right"})})]})}),e.jsxs("div",{className:"flex-grow-1 p-3",style:{overflow:"auto"},children:[r&&e.jsx("div",{children:e.jsx("div",{className:"table-responsive",children:e.jsx("table",{className:"table table-sm table-striped",style:{fontSize:"0.875rem"},children:e.jsx("tbody",{children:t.map((c,u)=>e.jsxs("tr",{children:[e.jsx("td",{className:"fw-bold text-muted",style:{width:"40%",whiteSpace:"nowrap"},children:c}),e.jsx("td",{className:"text-truncate",style:{maxWidth:"200px"},title:r[c]!==null&&r[c]!==void 0?String(r[c]):"NULL",children:r[c]!==null&&r[c]!==void 0?String(r[c]):e.jsx("span",{className:"text-muted",children:"NULL"})})]},u))})})})}),!r&&i.length>0&&e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-info-circle display-4 mb-3"}),e.jsx("div",{children:"No row selected"}),e.jsx("small",{children:"Click on a row in the results table to view its details"})]}),i.length===0&&!n&&!a&&e.jsxs("div",{className:"text-center text-muted",children:[e.jsx("i",{className:"bi bi-table display-4 mb-3"}),e.jsx("div",{children:"No results to display"}),e.jsx("small",{children:"Execute a query to see results"})]})]})]}),ht=o.memo(ut),mt=({schemaName:i,models:t,selectedTable:n,className:a=""})=>{const[r,l]=o.useState(""),h=o.useMemo(()=>{const c=[];return t.forEach(u=>{const g=u.schema||u.schema_name||u.database_schema||"default";n&&u.name===n.name?u.columns&&u.columns.forEach(S=>{c.push({name:S.name,table:u.name,type:S.type||"N/A",nullable:S.nullable||!1,description:S.description,schema:g,spatial_type:S.spatial_type,semantic_role:S.semantic_role})}):n||(i==="default"||g===i)&&u.columns&&u.columns.forEach(S=>{c.push({name:S.name,table:u.name,type:S.type||"N/A",nullable:S.nullable||!1,description:S.description,schema:g,spatial_type:S.spatial_type,semantic_role:S.semantic_role})})}),c.sort((u,g)=>u.schema!==g.schema?u.schema.localeCompare(g.schema):u.name!==g.name?u.name.localeCompare(g.name):u.table.localeCompare(g.table))},[t,i,n]),b=o.useMemo(()=>{if(!r.trim())return h;const c=r.toLowerCase();return h.filter(u=>u.name.toLowerCase().includes(c)||u.table.toLowerCase().includes(c)||u.type.toLowerCase().includes(c)||u.description&&u.description.toLowerCase().includes(c))},[h,r]);return h.length===0?e.jsxs("div",{className:`p-4 text-center text-muted ${a}`,children:[e.jsx("i",{className:"bi bi-database fs-1 mb-3",style:{color:"#aa0000"}}),e.jsx("h5",{style:{color:"#aa0000"},children:"No Columns Found"}),e.jsxs("p",{children:["No columns available ",n?`for table "${n.name}"`:i==="default"?"in any schema":`for schema "${i}"`]})]}):e.jsxs("div",{className:`p-3 ${a}`,style:{overflow:"auto",maxHeight:"100%"},children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx("i",{className:`bi ${n?"bi-table":"bi-database"} me-2`,style:{color:"#aa0000"}}),e.jsx("h4",{className:"mb-0",style:{color:"#aa0000"},children:n?`Table: ${n.name}`:i==="default"?"All Schemas":`Schema: ${i}`})]}),e.jsx("div",{className:"text-muted small",children:e.jsxs("span",{className:"badge me-2",style:{backgroundColor:"#aa0000",color:"white"},children:[n?`${h.length} columns`:`${h.length} columns across ${new Set(h.map(c=>c.table)).size} tables`,!n&&i==="default"&&` in ${new Set(h.map(c=>c.schema)).size} schemas`]})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",style:{backgroundColor:"#fff5f5",borderColor:"#aa0000"},children:e.jsx("i",{className:"bi bi-search",style:{color:"#aa0000"}})}),e.jsx("input",{type:"text",className:"form-control",placeholder:"Filter columns by name, table, type, or description...",value:r,onChange:c=>l(c.target.value),style:{borderColor:"#aa0000"}})]}),r&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-muted",children:["Showing ",b.length," of ",h.length," columns"]})})]}),e.jsxs("div",{children:[e.jsxs("h6",{className:"mb-3",style:{color:"#aa0000"},children:[e.jsx("i",{className:"bi bi-table me-1",style:{color:"#aa0000"}}),"All Columns (",b.length,")"]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm table-hover",children:[e.jsx("thead",{style:{backgroundColor:"#fff5f5"},children:e.jsxs("tr",{children:[e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Column"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Table"}),i==="default"&&e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Schema"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Type"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Semantic Role"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Nullable"}),e.jsx("th",{style:{color:"#aa0000",borderBottom:"2px solid #aa0000"},children:"Description"})]})}),e.jsx("tbody",{children:b.map((c,u)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{style:{color:"#aa0000"},children:c.name})}),e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsx("span",{className:"badge",style:{backgroundColor:"#f8f9fa",color:"#aa0000",border:"1px solid #aa0000",padding:"0.25em 0.4em",fontSize:"0.75em",fontWeight:"700"},children:c.table})}),i==="default"&&e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsx("span",{className:"badge",style:{backgroundColor:"#aa0000",color:"white"},children:c.schema})}),e.jsx("td",{style:{verticalAlign:"middle"},children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"badge",style:{backgroundColor:"#aa0000",color:"white"},children:c.type}),c.spatial_type&&c.spatial_type!==null&&c.spatial_type!==""&&e.jsx("span",{className:"badge ms-2",style:{backgroundColor:"transparent",color:"#aa0000",border:"1px solid #aa0000"},children:c.spatial_type})]})}),e.jsx("td",{style:{verticalAlign:"middle"},children:c.semantic_role&&c.semantic_role!==null&&c.semantic_role!==""?e.jsx("span",{className:"badge",style:{backgroundColor:"#f8f9fa",color:"#aa0000",border:"1px solid #aa0000"},children:c.semantic_role}):e.jsx("span",{className:"text-muted",children:"-"})}),e.jsx("td",{children:c.nullable?e.jsx("span",{style:{color:"#666"},children:"Yes"}):e.jsx("span",{className:"fw-bold",style:{color:"#aa0000"},children:"No"})}),e.jsx("td",{className:"small",style:{color:"#666"},children:c.description||"-"})]},`${c.table}-${c.name}-${u}`))})]})})]})]})},ft=({isOpen:i,onClose:t,onSave:n,defaultName:a,isSaving:r=!1})=>{const[l,h]=o.useState(""),[b,c]=o.useState(""),[u,g]=o.useState(!1);o.useEffect(()=>{i&&(h(a),c(""),g(!1))},[i,a]);const S=j=>{j.preventDefault(),l.trim()&&n({name:l.trim(),description:b.trim(),isPublic:u})},T=()=>{r||t()};return i?e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},tabIndex:-1,children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-save me-2"}),"Save Query"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:T,disabled:r})]}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{htmlFor:"queryName",className:"form-label",children:["Query Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",className:"form-control",id:"queryName",value:l,onChange:j=>h(j.target.value),placeholder:"Enter a name for your query",required:!0,disabled:r,autoFocus:!0})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"queryDescription",className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",id:"queryDescription",rows:3,value:b,onChange:j=>c(j.target.value),placeholder:"Optional description of what this query does",disabled:r})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"isPublic",checked:u,onChange:j=>g(j.target.checked),disabled:r}),e.jsxs("label",{className:"form-check-label",htmlFor:"isPublic",children:[e.jsx("i",{className:"bi bi-globe me-1"}),"Make this query public"]}),e.jsx("div",{className:"form-text",children:"Public queries can be seen and used by other users"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:T,disabled:r,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!l.trim()||r,children:r?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-save me-2"}),"Save Query"]})})]})]})]})})}):null},ue=({onResize:i,className:t=""})=>{const n=o.useRef(null),a=o.useRef(!1),r=o.useRef(0);return o.useEffect(()=>{const l=c=>{n.current?.contains(c.target)&&(a.current=!0,r.current=c.clientX,document.body.style.cursor="col-resize",document.body.style.userSelect="none",c.preventDefault())},h=c=>{if(a.current){const u=c.clientX-r.current;i(u),r.current=c.clientX}},b=()=>{a.current&&(a.current=!1,document.body.style.cursor="",document.body.style.userSelect="")};return document.addEventListener("mousedown",l),document.addEventListener("mousemove",h),document.addEventListener("mouseup",b),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",b)}},[i]),e.jsx("div",{ref:n,className:`resize-handle ${t}`,style:{width:"4px",backgroundColor:"#dee2e6",cursor:"col-resize",position:"relative",flexShrink:0},children:e.jsx("div",{style:{position:"absolute",top:0,left:"-2px",right:"-2px",bottom:0,backgroundColor:"transparent"}})})},xt=({onResize:i,className:t=""})=>{const n=o.useRef(null),a=o.useRef(!1),r=o.useRef(0);return o.useEffect(()=>{const l=c=>{n.current?.contains(c.target)&&(a.current=!0,r.current=c.clientY,document.body.style.cursor="row-resize",document.body.style.userSelect="none",c.preventDefault())},h=c=>{if(a.current){const u=c.clientY-r.current;i(u),r.current=c.clientY}},b=()=>{a.current&&(a.current=!1,document.body.style.cursor="",document.body.style.userSelect="")};return document.addEventListener("mousedown",l),document.addEventListener("mousemove",h),document.addEventListener("mouseup",b),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",b)}},[i]),e.jsx("div",{ref:n,className:`horizontal-resize-handle ${t}`,style:{height:"4px",backgroundColor:"#dee2e6",cursor:"row-resize",position:"relative",flexShrink:0,width:"100%",transition:"background-color 0.2s"},children:e.jsx("div",{style:{position:"absolute",top:"-2px",left:0,right:0,bottom:"-2px",backgroundColor:"transparent"}})})},gt=[{label:"SELECT",kind:"Keyword",insertText:"SELECT",documentation:"Select data from tables"},{label:"FROM",kind:"Keyword",insertText:"FROM",documentation:"Specify the source table(s)"},{label:"WHERE",kind:"Keyword",insertText:"WHERE",documentation:"Filter rows based on conditions"},{label:"GROUP BY",kind:"Keyword",insertText:"GROUP BY",documentation:"Group rows by columns"},{label:"HAVING",kind:"Keyword",insertText:"HAVING",documentation:"Filter groups"},{label:"ORDER BY",kind:"Keyword",insertText:"ORDER BY",documentation:"Sort the result set"},{label:"LIMIT",kind:"Keyword",insertText:"LIMIT",documentation:"Limit the number of rows returned"},{label:"OFFSET",kind:"Keyword",insertText:"OFFSET",documentation:"Skip a number of rows"},{label:"DISTINCT",kind:"Keyword",insertText:"DISTINCT",documentation:"Remove duplicate rows"},{label:"ALL",kind:"Keyword",insertText:"ALL",documentation:"Include all rows"},{label:"AS",kind:"Keyword",insertText:"AS",documentation:"Create an alias"},{label:"JOIN",kind:"Keyword",insertText:"JOIN",documentation:"Join tables together"},{label:"INNER JOIN",kind:"Keyword",insertText:"INNER JOIN",documentation:"Inner join tables"},{label:"LEFT JOIN",kind:"Keyword",insertText:"LEFT JOIN",documentation:"Left outer join tables"},{label:"RIGHT JOIN",kind:"Keyword",insertText:"RIGHT JOIN",documentation:"Right outer join tables"},{label:"FULL JOIN",kind:"Keyword",insertText:"FULL JOIN",documentation:"Full outer join tables"},{label:"CROSS JOIN",kind:"Keyword",insertText:"CROSS JOIN",documentation:"Cross join tables"},{label:"NATURAL JOIN",kind:"Keyword",insertText:"NATURAL JOIN",documentation:"Natural join tables"},{label:"ON",kind:"Keyword",insertText:"ON",documentation:"Specify join condition"},{label:"USING",kind:"Keyword",insertText:"USING",documentation:"Specify columns for natural join"},{label:"UNION",kind:"Keyword",insertText:"UNION",documentation:"Combine result sets"},{label:"UNION ALL",kind:"Keyword",insertText:"UNION ALL",documentation:"Combine result sets including duplicates"},{label:"INTERSECT",kind:"Keyword",insertText:"INTERSECT",documentation:"Find common rows"},{label:"EXCEPT",kind:"Keyword",insertText:"EXCEPT",documentation:"Find rows in first set but not second"},{label:"IN",kind:"Keyword",insertText:"IN",documentation:"Check if value is in list"},{label:"EXISTS",kind:"Keyword",insertText:"EXISTS",documentation:"Check if subquery returns rows"},{label:"ANY",kind:"Keyword",insertText:"ANY",documentation:"Compare with any value in list"},{label:"SOME",kind:"Keyword",insertText:"SOME",documentation:"Compare with some values in list"},{label:"COUNT",kind:"Keyword",insertText:"COUNT",documentation:"Count number of rows"},{label:"SUM",kind:"Keyword",insertText:"SUM",documentation:"Sum of values"},{label:"AVG",kind:"Keyword",insertText:"AVG",documentation:"Average of values"},{label:"MIN",kind:"Keyword",insertText:"MIN",documentation:"Minimum value"},{label:"MAX",kind:"Keyword",insertText:"MAX",documentation:"Maximum value"},{label:"CASE",kind:"Keyword",insertText:"CASE",documentation:"Conditional expression"},{label:"WHEN",kind:"Keyword",insertText:"WHEN",documentation:"Condition in CASE statement"},{label:"THEN",kind:"Keyword",insertText:"THEN",documentation:"Result in CASE statement"},{label:"ELSE",kind:"Keyword",insertText:"ELSE",documentation:"Default result in CASE statement"},{label:"END",kind:"Keyword",insertText:"END",documentation:"End of CASE statement"},{label:"COALESCE",kind:"Keyword",insertText:"COALESCE",documentation:"Return first non-null value"},{label:"NULLIF",kind:"Keyword",insertText:"NULLIF",documentation:"Return null if values are equal"},{label:"GREATEST",kind:"Keyword",insertText:"GREATEST",documentation:"Return largest value"},{label:"LEAST",kind:"Keyword",insertText:"LEAST",documentation:"Return smallest value"},{label:"CAST",kind:"Keyword",insertText:"CAST",documentation:"Convert data type"},{label:"LIKE",kind:"Keyword",insertText:"LIKE",documentation:"Pattern matching"},{label:"ILIKE",kind:"Keyword",insertText:"ILIKE",documentation:"Case-insensitive pattern matching"},{label:"NOT",kind:"Keyword",insertText:"NOT",documentation:"Logical NOT operator"},{label:"AND",kind:"Keyword",insertText:"AND",documentation:"Logical AND operator"},{label:"OR",kind:"Keyword",insertText:"OR",documentation:"Logical OR operator"},{label:"BETWEEN",kind:"Keyword",insertText:"BETWEEN",documentation:"Check if value is between two values"},{label:"IS",kind:"Keyword",insertText:"IS",documentation:"Check for null or boolean values"},{label:"IS NULL",kind:"Keyword",insertText:"IS NULL",documentation:"Check if value is null"},{label:"IS NOT NULL",kind:"Keyword",insertText:"IS NOT NULL",documentation:"Check if value is not null"},{label:"ASC",kind:"Keyword",insertText:"ASC",documentation:"Ascending sort order"},{label:"DESC",kind:"Keyword",insertText:"DESC",documentation:"Descending sort order"},{label:"ROW_NUMBER",kind:"Keyword",insertText:"ROW_NUMBER",documentation:"Row number window function"},{label:"RANK",kind:"Keyword",insertText:"RANK",documentation:"Rank window function"},{label:"DENSE_RANK",kind:"Keyword",insertText:"DENSE_RANK",documentation:"Dense rank window function"},{label:"NTILE",kind:"Keyword",insertText:"NTILE",documentation:"NTILE window function"},{label:"OVER",kind:"Keyword",insertText:"OVER",documentation:"Window function clause"},{label:"PARTITION BY",kind:"Keyword",insertText:"PARTITION BY",documentation:"Partition window function"},{label:"WINDOW",kind:"Keyword",insertText:"WINDOW",documentation:"Define named window"},{label:"WITH",kind:"Keyword",insertText:"WITH",documentation:"Common table expression"},{label:"RECURSIVE",kind:"Keyword",insertText:"RECURSIVE",documentation:"Recursive common table expression"},{label:"LATERAL",kind:"Keyword",insertText:"LATERAL",documentation:"Lateral join"},{label:"VALUES",kind:"Keyword",insertText:"VALUES",documentation:"Define values for INSERT"},{label:"FETCH",kind:"Keyword",insertText:"FETCH",documentation:"Fetch rows from cursor"},{label:"NEXT",kind:"Keyword",insertText:"NEXT",documentation:"Next row in cursor"},{label:"ONLY",kind:"Keyword",insertText:"ONLY",documentation:"Only rows, not including ties"},{label:"TOP",kind:"Keyword",insertText:"TOP",documentation:"Top N rows"},{label:"EXPLAIN",kind:"Keyword",insertText:"EXPLAIN",documentation:"Explain query execution plan"},{label:"ANALYZE",kind:"Keyword",insertText:"ANALYZE",documentation:"Analyze query execution"},{label:"DISTINCT ON",kind:"Keyword",insertText:"DISTINCT ON",documentation:"Distinct on specific columns"}],pt=({onQuerySaved:i,className:t=""})=>{const{uiState:n,updateUIState:a,selectionState:r,updateSelectionState:l,sqlGenerationState:h,updateSqlGenerationState:b,executionState:c,updateExecutionState:u,addToExecutionHistory:g,showSuccess:S,showError:T,getTabChartConfig:j,setTabChartConfig:C,removeTabChartConfig:$,getDefaultChartConfig:I}=se(),[w,_]=o.useState([]),[P,K]=o.useState([]);o.useEffect(()=>{const f=()=>{_(v.instance.getModels()),K(v.instance.getSpatialColumns())};return f(),v.instance.addModelsChangedListener(f),()=>{v.instance.removeModelsChangedListener(f)}},[]);const[D,N]=o.useState([{id:"docs",name:"📋 Models",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}},{id:"1",name:"Query 1",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}}]),[m,s]=o.useState("1"),[d,x]=o.useState(2),[k,R]=o.useState(!1),[E,L]=o.useState(!1),O=o.useRef(null),q=o.useRef("1"),M=o.useRef([{id:"docs",name:"📋 Models",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}},{id:"1",name:"Query 1",queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}}]);o.useEffect(()=>{q.current=m},[m]),o.useEffect(()=>{M.current=D},[D]),o.useEffect(()=>{if(r.selectedQuery){const f={id:d.toString(),name:r.selectedQuery.name||"Saved Query",queryText:r.selectedQuery.sqlText||"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:r.selectedQuery.chartConfig||null},originalQuery:r.selectedQuery};N(p=>[...p,f]),x(p=>p+1),s(f.id),r.selectedQuery.chartConfig&&C(f.id,r.selectedQuery.chartConfig),l({selectedQuery:null})}},[r.selectedQuery,d,l,C]),o.useEffect(()=>{r.selectedSchema&&s("docs")},[r.selectedSchema]),o.useEffect(()=>{h.generatedSql&&(N(f=>f.map(p=>{if(p.id===m){const y=p.queryText||"",A=h.generatedSql,F=y.trim()===""?"":`

-- AI Generated SQL
`,U=y+F+A;return{...p,queryText:U}}return p})),b({generatedSql:null}))},[h.generatedSql,m,b]),o.useEffect(()=>{if(m&&m!=="docs"&&w.length>0){const f=D.find(y=>y.id===m),p=j(m);if(f?.results.columns&&f.results.columns.length>0&&!p&&!f.results.chartConfig){const y=I(f.results.columns);C(m,y),N(A=>A.map(F=>F.id===m?{...F,results:{...F.results,chartConfig:y}}:F))}}},[m,w.length]);const z=D.find(f=>f.id===m);o.useEffect(()=>{if(O.current&&w.length>0){O.current.setValue(oe(O.current.getValue(),{language:"postgresql"})),O.current.completionProvider&&(O.current.completionProvider.dispose(),O.current.completionProvider=null);const f=window.monaco;if(f){const p=f.languages.registerCompletionItemProvider("sql",{triggerCharacters:[" ",".",",","(",")","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],provideCompletionItems:(y,A)=>{const F=y.getWordUntilPosition(A),U={startLineNumber:A.lineNumber,endLineNumber:A.lineNumber,startColumn:F.startColumn,endColumn:F.endColumn},Y=[];gt.map(G=>({...G,kind:f.languages.CompletionItemKind.Keyword})).forEach(G=>{Y.push({...G,range:U})});const he=y.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:A.lineNumber,endColumn:A.column}),me=he.match(/([a-zA-Z_$][\w$]*)\s*\.\s*$/i);let re=!1,X=null,ie=null;if(me){const G=me[1];re=!0;const Q=new Map,V=he.matchAll(/(?:FROM|JOIN)\s+([a-zA-Z_$][\w$]*\.?[a-zA-Z_$][\w$]*)\s+(?:AS\s+)?([a-zA-Z_$][\w$]*)/gi);for(const Z of V){const Ae=Z[1],Oe=Z[2];Q.set(Oe,Ae)}Q.has(G)?(ie=G,X=Q.get(G)):X=G}if(w&&w.length>0&&!re&&w.forEach(G=>{const Q=G.schema||G.schema_name||G.database_schema||"default",V=G.name||G.table_name;V&&(Y.push({label:V,kind:f.languages.CompletionItemKind.Class,insertText:V,documentation:`Table: ${V} (Schema: ${Q})`,detail:`Table in ${Q} schema`,range:U}),Y.push({label:`${Q}.${V}`,kind:f.languages.CompletionItemKind.Class,insertText:`${Q}.${V}`,documentation:`Table: ${V} (Schema: ${Q})`,detail:"Fully qualified table name",range:U}))}),re&&X&&w&&w.length>0){const G=w.find(Q=>{const V=Q.schema||Q.schema_name||Q.database_schema||"default",Z=Q.name||Q.table_name;return Z===X||`${V}.${Z}`===X});G&&G.columns&&Array.isArray(G.columns)&&G.columns.forEach(Q=>{Y.push({label:Q.name,kind:f.languages.CompletionItemKind.Field,insertText:Q.name,documentation:`Column: ${Q.name} (Type: ${Q.type})${ie?` from alias ${ie}`:""}`,detail:`${Q.type}${Q.nullable?" (nullable)":" (not null)"}`,range:U})})}return{suggestions:Y}}});O.current.completionProvider=p}}return()=>{O.current&&O.current.completionProvider&&(O.current.completionProvider.dispose(),O.current.completionProvider=null)}},[w]);const ne=o.useCallback(()=>{const f={id:d.toString(),name:`Query ${d}`,queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}};N(p=>[...p,f]),x(p=>p+1),s(f.id)},[d]),J=o.useCallback(f=>{if(f==="docs")return;if($(f),D.length<=2){const y={id:d.toString(),name:`Query ${d}`,queryText:"",results:{results:[],columns:[],rowCount:0,executionError:null,executionMetadata:null,selectedRowIndex:null,chartConfig:null}};N(A=>[...A.filter(F=>F.id==="docs"),y]),x(A=>A+1),s(y.id);return}const p=D.filter(y=>y.id!==f);if(N(p),m===f){const y=D.findIndex(U=>U.id===f),A=y>0?y-1:0,F=p[A].id;s(F)}},[D,m,d,$]),Se=o.useCallback(f=>{s(f)},[]),Ne=o.useCallback(f=>{N(p=>p.map(y=>y.id===m?{...y,queryText:f}:y))},[m]),ae=o.useCallback(async(f,p)=>{u({isExecuting:!0,activeTabId:p});try{const y=await W.instance.executeSql(f);if(y&&y.data)N(A=>A.map(F=>F.id===p?{...F,results:{results:y.data||[],columns:y.columns||[],rowCount:y.row_count||0,executionError:null,executionMetadata:y.metadata||null,selectedRowIndex:null,chartConfig:null}}:F)),g({sql:f,tabId:p,success:!0}),y.row_count>0?S(`Query executed successfully. ${y.row_count} rows returned.`):S("Query executed successfully.");else{const A=y.error||"Failed to execute query";N(F=>F.map(U=>U.id===p?{...U,results:{...U.results,executionError:A,results:[],columns:[],rowCount:0,selectedRowIndex:null}}:U)),g({sql:f,tabId:p,success:!1,error:A}),T(A)}}catch(y){const A=y instanceof Error?y.message:"Unknown error occurred";N(F=>F.map(U=>U.id===p?{...U,results:{...U.results,executionError:A,results:[],columns:[],rowCount:0,selectedRowIndex:null}}:U)),g({sql:f,tabId:p,success:!1,error:A}),T(A)}finally{u({isExecuting:!1,activeTabId:null})}},[u,g,S,T]),we=o.useCallback(async f=>{let p=f;if(!p&&O.current){const y=O.current.getSelection();y&&!y.isEmpty()?p=O.current.getModel()?.getValueInRange(y)||"":p=O.current.getValue()||""}p||(p=z?.queryText||""),await ae(p,m)},[m,z?.queryText,ae]),ve=o.useCallback(f=>{N(p=>p.map(y=>y.id===m?{...y,results:{...y.results,selectedRowIndex:f}}:y))},[m]),Ce=o.useCallback(f=>{m&&f&&C(m,f),N(p=>p.map(y=>y.id===m?{...y,results:{...y.results,chartConfig:f?{...f}:null}}:y))},[m]),je=o.useCallback(f=>{const p=Math.max(150,Math.min(500,n.resultsDetailsWidth+f));a({resultsDetailsWidth:p})},[n.resultsDetailsWidth,a]),ke=o.useCallback(()=>{a({isResultsDetailsCollapsed:!n.isResultsDetailsCollapsed})},[n.isResultsDetailsCollapsed,a]),Te=o.useCallback(f=>{const p=n.queryEditorHeight+f/window.innerHeight*100,y=Math.max(20,Math.min(80,p));a({queryEditorHeight:y})},[n.queryEditorHeight,a]),Ee=o.useCallback(async()=>{if(m==="docs")return;const f=D.find(p=>p.id===m);if(f)if(f.originalQuery){L(!0);try{const p={guid:f.originalQuery.guid,name:f.originalQuery.name,description:f.originalQuery.description,sqlText:f.queryText,chartConfig:f.results.chartConfig,isPublic:f.originalQuery.isPublic};if(await W.instance.saveQuery(p))i&&i();else throw new Error("Failed to save query")}catch(p){console.error("Error saving query:",p)}finally{L(!1)}}else R(!0)},[m,D,i]),Le=o.useCallback(async f=>{if(m!=="docs"){L(!0);try{const p=D.find(F=>F.id===m);if(!p)throw new Error("No active tab found");const y={guid:crypto.randomUUID(),name:f.name,description:f.description,sqlText:p.queryText,chartConfig:p.results.chartConfig,isPublic:f.isPublic};if(await W.instance.saveQuery(y))R(!1),i&&i();else throw new Error("Failed to save query")}catch(p){console.error("Error saving query:",p)}finally{L(!1)}}},[m,D,i]),Ie=o.useCallback(()=>{E||R(!1)},[E]),_e=o.useCallback(()=>{if(O.current){const f=O.current.getValue(),p=oe(f,{language:"postgresql"});O.current.setValue(p),N(y=>y.map(A=>A.id===m?{...A,queryText:p}:A))}},[m]),Me=o.useMemo(()=>z?.results.selectedRowIndex!==null&&z?.results.results?z.results.results[z.results.selectedRowIndex]:null,[z?.results.selectedRowIndex,z?.results.results]);return e.jsxs("div",{className:`d-flex flex-column h-100 ${t}`,style:{overflow:"hidden"},children:[e.jsx("div",{className:"border-bottom",style:{flexShrink:0,paddingTop:"calc(0.5rem - 3px)",borderBottomWidth:"1px"},children:e.jsx("div",{className:"d-flex align-items-center",children:e.jsxs("div",{className:"tab-scroll-container d-flex flex-grow-1",style:{overflow:"hidden"},children:[D.map(f=>e.jsxs("div",{className:`tab-item ${m===f.id?"active":""}`,onClick:()=>Se(f.id),children:[e.jsx("span",{className:"tab-name",children:f.name}),f.id!=="docs"&&e.jsx("button",{className:"tab-close",onClick:p=>{p.stopPropagation(),J(f.id)},children:e.jsx("i",{className:"bi bi-x"})})]},f.id)),e.jsx("div",{className:"tab-item new-tab-tab",onClick:ne,title:"New Query",children:e.jsx("i",{className:"bi bi-plus"})})]})})}),e.jsx("div",{className:"flex-grow-1 d-flex flex-column",style:{minHeight:0,position:"relative",overflow:"hidden"},children:m==="docs"?e.jsx("div",{className:"flex-grow-1",style:{overflow:"auto",maxHeight:"100%"},children:e.jsx(mt,{schemaName:r.selectedSchema||"default",models:w,selectedTable:r.selectedTable,className:"h-100"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{height:`${n.queryEditorHeight}%`,minHeight:0},children:e.jsxs("div",{className:"bg-light border-start d-flex flex-column h-100",style:{overflow:"hidden"},children:[e.jsx("div",{className:"flex-grow-1",style:{height:"100%",overflow:"hidden"},children:e.jsx(Pe,{height:"100%",language:"sql",value:z?.queryText||"",onChange:f=>Ne(f||""),onMount:(f,p)=>{O.current=f,p.languages.register({id:"sql"}),p.languages.setMonarchTokensProvider("sql",{tokenizer:{root:[[/[a-zA-Z_$][\w$]*/,{cases:{"@keywords":"keyword","@default":"identifier"}}],[/\d*\.\d+([eE][\-+]?\d+)?[fFdD]?/,"number.float"],[/0[xX][0-9a-fA-F]+[Ll]?/,"number.hex"],[/\d+[lL]?/,"number"],[/[;,.]/,"delimiter"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/\/\*/,"comment","@comment"],[/--.*$/,"comment"]],string_double:[[/[^\\"]+/,"string"],[/\\./,"string.escape"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/\\./,"string.escape"],[/'/,"string","@pop"]],comment:[[/[^\/*]+/,"comment"],[/\*\//,"comment","@pop"],[/[\/*]/,"comment"]]},keywords:["SELECT","FROM","WHERE","GROUP","BY","HAVING","ORDER","LIMIT","OFFSET","DISTINCT","ALL","AS","JOIN","INNER","LEFT","RIGHT","FULL","CROSS","NATURAL","ON","USING","UNION","INTERSECT","EXCEPT","IN","EXISTS","ANY","SOME","COUNT","SUM","AVG","MIN","MAX","CASE","WHEN","THEN","ELSE","END","COALESCE","NULLIF","GREATEST","LEAST","CAST","LIKE","ILIKE","NOT","AND","OR","BETWEEN","IS","NULL","ASC","DESC","ROW_NUMBER","RANK","DENSE_RANK","NTILE","OVER","PARTITION","WINDOW","WITH","RECURSIVE","LATERAL","VALUES","FETCH","NEXT","ONLY","TOP","EXPLAIN","ANALYZE"]}),f.addAction({id:"format-sql",label:"Format SQL",keybindings:[p.KeyMod.Shift|p.KeyMod.Alt|p.KeyCode.KeyF],run:y=>{const A=oe(y.getValue(),{language:"postgresql"});y.setValue(A)}}),f.addCommand(p.KeyMod.CtrlCmd|p.KeyCode.Enter,()=>{const y=q.current;if(y!=="docs"){const A=f.getValue()||"";N(F=>F.map(U=>U.id===y?{...U,queryText:A}:U)),ae(A,y)}}),f.addCommand(p.KeyMod.CtrlCmd|p.KeyCode.Space,()=>{f.trigger("","editor.action.triggerSuggest",{})})},options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"on",wordWrap:"on",folding:!0,lineDecorationsWidth:10,lineNumbersMinChars:3,renderLineHighlight:"all",scrollbar:{vertical:"auto",horizontal:"auto",verticalScrollbarSize:8,horizontalScrollbarSize:8},suggest:{showKeywords:!0,showSnippets:!0,showFunctions:!0,showConstructors:!0,showFields:!0,showVariables:!0,showClasses:!0,showStructs:!0,showInterfaces:!0,showModules:!0,showProperties:!0,showEvents:!0,showOperators:!0,showUnits:!0,showValues:!0,showConstants:!0,showEnums:!0,showEnumMembers:!0,showColors:!0,showFiles:!0,showReferences:!0,showFolders:!0,showTypeParameters:!0,showIssues:!0,showUsers:!0,showWords:!0},quickSuggestions:{other:!0,comments:!1,strings:!1},parameterHints:{enabled:!0},hover:{enabled:!0},contextmenu:!0,mouseWheelZoom:!0,multiCursorModifier:"ctrlCmd",formatOnPaste:!0,formatOnType:!0},theme:"vs"})}),e.jsx("div",{className:"p-3 border-top",style:{flexShrink:0},children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("button",{className:"btn",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white",width:"100px"},onClick:()=>we(),children:[e.jsx("i",{className:"bi bi-play me-1"}),"Run"]}),e.jsx("button",{className:"btn btn-outline-secondary",style:{width:"100px"},onClick:Ee,disabled:m==="docs"||E,children:E?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-floppy me-1"}),"Save"]})}),e.jsxs("button",{className:"btn btn-outline-secondary",style:{width:"100px"},onClick:_e,children:[e.jsx("i",{className:"bi bi-journal-richtext me-1"}),"Format"]})]})})]})}),e.jsx(xt,{onResize:Te}),e.jsxs("div",{className:"d-flex",style:{height:`${100-n.queryEditorHeight}%`,minHeight:"200px"},children:[e.jsx("div",{className:"flex-grow-1",style:{minWidth:0,height:"100%"},children:e.jsx(dt,{results:z?.results.results||[],columns:z?.results.columns||[],rowCount:z?.results.rowCount||0,isExecuting:c.isExecuting,error:z?.results.executionError||null,selectedRowIndex:z?.results.selectedRowIndex||null,onRowSelect:ve,metadata:z?.results.executionMetadata||null,spatialColumns:P,chartConfig:j(m),onChartConfigChange:Ce,tabId:m,className:"h-100"})}),!n.isResultsDetailsCollapsed&&e.jsx(ue,{onResize:je}),e.jsx("div",{style:{width:n.isResultsDetailsCollapsed?"40px":`${n.resultsDetailsWidth}px`,flexShrink:0,transition:"width 0.3s ease"},children:e.jsx(ht,{results:z?.results.results||[],columns:z?.results.columns||[],rowCount:z?.results.rowCount||0,isExecuting:c.isExecuting,error:z?.results.executionError||null,selectedRow:Me,isCollapsed:n.isResultsDetailsCollapsed,onToggle:ke})})]})]})}),e.jsx(ft,{isOpen:k,onClose:Ie,onSave:Le,defaultName:z?.name||"New Query",isSaving:E})]})},bt=({className:i="",isCollapsed:t=!1,onToggle:n})=>{const{updateSqlGenerationState:a,showError:r}=se(),[l,h]=o.useState([]),[b,c]=o.useState([]),[u,g]=o.useState(""),[S,T]=o.useState(!1),j=o.useRef(null);o.useEffect(()=>{j.current&&(j.current.scrollTop=j.current.scrollHeight)},[l]);const C=async()=>{if(u.trim()&&!S){const w={id:Date.now(),text:u,sender:"user"};h(_=>[..._,w]),g(""),T(!0),a({isGenerating:!0,lastPrompt:u});try{const _=await W.instance.sendPrompt(u,b);if(_&&_.sql){a({generatedSql:_.sql,isGenerating:!1});const P={id:Date.now()+1,text:"Your SQL is in the query editor.",sender:"ai"};h(K=>[...K,P]),c(K=>[...K,{user_prompt:u,system_response:_.sql}])}else{const P=JSON.stringify(_,null,2),K={id:Date.now()+1,text:`**Data Service Response:**
\`\`\`json
${P}
\`\`\``,sender:"ai"};h(D=>[...D,K]),a({isGenerating:!1}),c(D=>[...D,{user_prompt:u,system_response:`**Data Service Response:**
\`\`\`json
${P}
\`\`\``}])}}catch{r("Failed to generate SQL. Please try again."),a({isGenerating:!1})}T(!1)}},$=w=>{w.key==="Enter"&&!w.shiftKey&&(w.preventDefault(),C())},I=()=>{h([]),c([])};return t?e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${i}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 d-flex justify-content-center",children:e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:n,title:"Expand chat panel",children:e.jsx("i",{className:"bi bi-chevron-left"})})}),e.jsx("div",{className:"flex-grow-1 d-flex justify-content-center align-items-center",children:e.jsx("div",{style:{writingMode:"vertical-rl",textOrientation:"mixed",transform:"rotate(360deg)",fontSize:"1rem",fontWeight:"500",color:"#aa0000"},children:"AI Assistant"})})]}):e.jsxs("div",{className:`bg-light border-start d-flex flex-column h-100 ${i}`,style:{height:"100%"},children:[e.jsx("div",{className:"p-2 border-bottom flex-shrink-0 panel-header",style:{background:"linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)",borderBottomWidth:"2px"},children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"text-muted mb-0 d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-chat-dots me-2"}),"AI Assistant"]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:I,disabled:l.length===0,title:"Clear chat history",children:e.jsx("i",{className:"bi bi-file-earmark"})}),e.jsx("button",{className:"btn btn-sm",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white"},onClick:n,title:"Collapse chat panel",children:e.jsx("i",{className:"bi bi-chevron-right"})})]})]})}),e.jsx("div",{ref:j,className:"flex-grow-1 p-3 overflow-auto chat-panel-scroll d-flex flex-column",children:e.jsxs("div",{className:"flex-grow-1",children:[l.map(w=>e.jsx("div",{className:`mb-3 ${w.sender==="user"?"text-end":"text-start"}`,children:e.jsx("div",{className:`d-inline-block p-2 rounded ${w.sender==="user"?"text-white":"bg-white border"}`,style:w.sender==="user"?{backgroundColor:"#aa0000"}:{},children:w.text})},w.id)),S&&e.jsx("div",{className:"mb-3 text-start",children:e.jsxs("div",{className:"d-inline-block p-2 rounded bg-white border",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"spinner-border spinner-border-sm text-danger me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("span",{className:"text-muted",children:"Generating response..."})]}),e.jsx("div",{className:"progress mt-2",style:{height:"4px"},children:e.jsx("div",{className:"progress-bar bg-danger",role:"progressbar",style:{width:"100%",animation:"progress-bar-stripes 1s linear infinite"}})})]})})]})}),e.jsx("div",{className:"p-3 border-top flex-shrink-0",children:e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("textarea",{className:"form-control flex-grow-1",placeholder:S?"Almost there...":"redfive standing by...",value:u,onChange:w=>g(w.target.value),onKeyPress:$,disabled:S,rows:3,style:{resize:"vertical",minHeight:"75px"}}),e.jsx("button",{className:"btn align-self-start",style:{backgroundColor:"#aa0000",borderColor:"#aa0000",color:"white",marginTop:"2px"},onClick:C,disabled:S||!u.trim(),children:S?e.jsx("i",{className:"bi bi-hourglass-split"}):e.jsx("i",{className:"bi bi-send"})})]})})]})},yt=({message:i,type:t,isVisible:n,onClose:a,duration:r=3e3})=>{const[l,h]=o.useState(!1);if(o.useEffect(()=>{if(n){h(!0);const u=setTimeout(()=>{h(!1),setTimeout(a,300)},r);return()=>clearTimeout(u)}},[n,r,a]),!n)return null;const b=()=>{const u="toast-notification",g={success:"toast-success",error:"toast-error",info:"toast-info"}[t];return`${u} ${g} ${l?"toast-show":"toast-hide"}`},c=()=>{switch(t){case"success":return e.jsx("i",{className:"bi bi-check-circle-fill me-2"});case"error":return e.jsx("i",{className:"bi bi-exclamation-triangle-fill me-2"});case"info":return e.jsx("i",{className:"bi bi-info-circle-fill me-2"});default:return null}};return e.jsx("div",{className:b(),children:e.jsxs("div",{className:"toast-content",children:[c(),e.jsx("span",{children:i}),e.jsx("button",{className:"toast-close",onClick:a,type:"button",children:e.jsx("i",{className:"bi bi-x"})})]})})},St=()=>{const[i,t]=o.useState([]);o.useEffect(()=>{const a=()=>{t(v.instance.getNotifications())};return a(),v.instance.addNotificationsChangedListener(a),()=>{v.instance.removeNotificationsChangedListener(a)}},[]);const n=a=>{v.instance.removeNotification(a)};return e.jsx(e.Fragment,{children:i.map(a=>e.jsx(yt,{message:a.message,type:a.type,isVisible:a.isVisible,onClose:()=>n(a.id),duration:a.duration},a.id))})};function Nt(){const{uiState:i,updateUIState:t,showSuccess:n}=se(),a=150,r=500,l=o.useCallback(u=>{const g=Math.max(a,Math.min(r,i.leftPanelWidth+u));t({leftPanelWidth:g})},[i.leftPanelWidth,t]),h=o.useCallback(u=>{const g=Math.max(a,Math.min(r,i.rightPanelWidth-u));t({rightPanelWidth:g})},[i.rightPanelWidth,t]),b=o.useCallback(()=>{t({isChatCollapsed:!i.isChatCollapsed})},[i.isChatCollapsed,t]),c=o.useCallback(()=>{n("Query saved successfully!")},[n]);return e.jsx(Qe,{children:e.jsxs(He,{children:[e.jsxs("div",{className:"d-flex flex-column",style:{height:"100vh",margin:0,padding:0},children:[e.jsx(Ge,{}),e.jsxs("div",{className:"flex-grow-1 d-flex",style:{height:"calc(100vh - 56px)",overflow:"hidden"},children:[e.jsx("div",{style:{width:`${i.leftPanelWidth}px`,flexShrink:0,height:"100%"},children:e.jsx(Ze,{})}),e.jsx(ue,{onResize:l}),e.jsx("div",{className:"flex-grow-1",style:{minWidth:0},children:e.jsx(pt,{onQuerySaved:c,className:"h-100"})}),e.jsx(ue,{onResize:h}),e.jsx("div",{style:{width:i.isChatCollapsed?"40px":`${i.rightPanelWidth}px`,flexShrink:0,transition:"width 0.3s ease"},children:e.jsx(bt,{isCollapsed:i.isChatCollapsed,onToggle:b})})]})]}),e.jsx(St,{})]})})}Ke.createRoot(document.getElementById("root")).render(e.jsx(o.StrictMode,{children:e.jsx(Nt,{})}));
